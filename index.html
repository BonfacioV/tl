<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tonnylays Construction</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1a365d;
            --secondary: #2b6cb0;
            --accent: #dd6b20;
            --success: #38a169;
            --danger: #e53e3e;
            --warning: #d69e2e;
            --info: #3182ce;
            --light: #f7fafc;
            --dark: #2d3748;
            --border: #e2e8f0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            font-size: 15px;
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Mobile Menu */
        .mobile-menu {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 10px;
        }

        .mobile-nav {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        .mobile-nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 5px;
            border: none;
            background: none;
            border-radius: 8px;
            font-size: 0.7rem;
            color: var(--dark);
            transition: all 0.3s;
        }

        .mobile-nav-btn i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .mobile-nav-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Desktop Menu */
        .desktop-menu {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .menu-btn {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* Main Container */
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 10px;
            padding-bottom: 70px;
        }

        /* Header */
        .header {
            background: white;
            color: var(--primary);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
        }

        .header h1 {
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1 i {
            color: var(--accent);
        }

        .header-controls {
            display: flex;
            gap: 8px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 8px;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 10px 15px;
            white-space: nowrap;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background-color: #f0f7ff;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: var(--secondary);
            box-shadow: 0 2px 4px rgba(43, 108, 176, 0.2);
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .section-header h2 {
            color: var(--primary);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            min-height: 40px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), #4c8bf5);
            color: white;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(66, 153, 225, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #48bb78);
            color: white;
            box-shadow: 0 2px 4px rgba(72, 187, 120, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(72, 187, 120, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #fc8181);
            color: white;
            box-shadow: 0 2px 4px rgba(245, 101, 101, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(245, 101, 101, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ed8936);
            color: white;
            box-shadow: 0 2px 4px rgba(237, 137, 54, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(237, 137, 54, 0.4);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-height: 32px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            border-left: 4px solid var(--secondary);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-header {
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background: linear-gradient(to bottom, var(--light), #edf2f7);
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background-color: #f8fafc;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Attendance Grid - IMPROVED */
        .attendance-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
        }

        .attendance-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .attendance-grid-container {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 15px;
            background: white;
        }

        .attendance-grid {
            min-width: 1000px;
            border-collapse: collapse;
        }

        .attendance-grid th {
            text-align: center;
            padding: 12px 8px;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            color: white;
            font-weight: 600;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .attendance-grid th:first-child {
            border-radius: 8px 0 0 0;
        }

        .attendance-grid th:last-child {
            border-radius: 0 8px 0 0;
        }

        .attendance-grid td {
            text-align: center;
            padding: 10px 8px;
            border: 1px solid var(--border);
        }

        .day-cell {
            width: 42px;
            min-width: 42px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            font-weight: bold;
            border-radius: 6px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .day-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .present {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            color: #22543d;
            border: 2px solid #38a169 !important;
            box-shadow: 0 2px 4px rgba(56, 161, 105, 0.2);
        }

        .absent {
            background: linear-gradient(135deg, #fed7d7, #fc8181);
            color: #742a2a;
            border: 2px solid #e53e3e !important;
            box-shadow: 0 2px 4px rgba(229, 62, 62, 0.2);
        }

        .worker-row {
            border-top: 1px solid var(--border);
        }

        .worker-name {
            font-weight: 600;
            white-space: nowrap;
            padding: 8px;
            background-color: #f8f9fa;
            width: 150px !important;
            min-width: 150px !important;
            max-width: 150px !important;
            position: sticky;
            left: 0;
            z-index: 1;
            border-right: 2px solid var(--border);
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent), var(--secondary));
        }

        .stat-card {
            text-align: center;
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-label {
            color: var(--dark);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 15px;
            backdrop-filter: blur(3px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .header-controls {
                width: 100%;
                justify-content: center;
            }

            .btn {
                width: 100%;
                padding: 12px;
            }

            .nav-tabs {
                display: none;
            }

            .mobile-menu {
                display: grid;
            }

            .content-section {
                padding: 12px;
            }

            .section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .section-header h2 {
                text-align: center;
            }

            .desktop-menu {
                display: none;
            }

            .menu-btn {
                display: block;
            }

            .worker-name {
                width: 120px !important;
                min-width: 120px !important;
                max-width: 120px !important;
            }

            .modal-content {
                margin: 10px;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu {
                display: none;
            }

            .desktop-menu {
                display: flex;
            }
        }

        /* Alerts */
        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .alert-error {
            background: linear-gradient(135deg, #fed7d7, #fc8181);
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .close-alert {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: inherit;
            padding: 0 5px;
        }

        /* Tabs */
        .sub-tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .sub-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            font-weight: 500;
            transition: all 0.3s;
        }

        .sub-tab.active {
            border-bottom-color: var(--secondary);
            color: var(--secondary);
            font-weight: 600;
        }

        /* Invoice */
        .invoice-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .invoice-form {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .invoice-preview-btn {
            width: 100%;
            margin-top: 15px;
        }

        /* Sites List - IMPROVED */
        .sites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .site-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .site-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .site-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .site-name {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .site-workers-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
        }

        .worker-tag {
            background: var(--light);
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8rem;
            color: var(--dark);
            border: 1px solid var(--border);
            margin: 2px;
            display: inline-block;
        }

        /* Loans Quick Add */
        .quick-add-loan {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .quick-add-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            align-items: end;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-inactive {
            background: #fed7d7;
            color: #742a2a;
        }

        .status-pending {
            background: #feebc8;
            color: #744210;
        }

        .status-paid {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-deducted {
            background: #bee3f8;
            color: #2c5282;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--secondary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Save Attendance Button */
        .save-attendance-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            padding: 0;
        }

        .save-attendance-btn i {
            font-size: 1.5rem;
        }

        /* Invoice Preview Modal */
        .invoice-preview-modal .modal-content {
            max-width: 800px;
        }

        .invoice-preview-content {
            padding: 20px;
            background: white;
        }

        .invoice-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .invoice-header h2 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .invoice-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .invoice-from,
        .invoice-to {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .invoice-items {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .invoice-totals {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .total-row:last-child {
            border-bottom: none;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--dark);
        }

        /* Worker List for Site Assignment */
        .worker-list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
        }

        .worker-list-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .worker-list-item:hover {
            background: #f8f9fa;
        }

        .worker-list-item:last-child {
            border-bottom: none;
        }

        .worker-checkbox {
            margin-right: 10px;
        }

        .worker-info {
            flex: 1;
        }

        .worker-role {
            font-size: 0.85rem;
            color: var(--dark);
        }
    </style>
</head>

<body>
    <!-- Mobile Menu -->
    <div class="mobile-menu">
        <div class="mobile-nav">
            <button class="mobile-nav-btn active" onclick="switchMobileTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchMobileTab('workers')">
                <i class="fas fa-users"></i>
                <span>Workers</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchMobileTab('attendance')">
                <i class="fas fa-clipboard-check"></i>
                <span>Attendance</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchMobileTab('payroll')">
                <i class="fas fa-money-check-alt"></i>
                <span>Payroll</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchMobileTab('loans')">
                <i class="fas fa-hand-holding-usd"></i>
                <span>Loans</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchMobileTab('sites')">
                <i class="fas fa-map-marker-alt"></i>
                <span>Sites</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchMobileTab('expenses')">
                <i class="fas fa-receipt"></i>
                <span>Expenses</span>
            </button>
            <button class="mobile-nav-btn" onclick="switchMobileTab('invoices')">
                <i class="fas fa-file-invoice"></i>
                <span>Invoices</span>
            </button>
        </div>
    </div>

    <div class="main-container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-hard-hat"></i> Tonnylays Construction</h1>
            <div class="header-controls">
                <button class="btn btn-primary btn-sm" onclick="backupData()">
                    <i class="fas fa-download"></i> Backup
                </button>
                <button class="btn btn-success btn-sm" onclick="showModal('restoreModal')">
                    <i class="fas fa-upload"></i> Restore
                </button>
                <button class="menu-btn" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </header>

        <!-- Desktop Navigation -->
        <nav class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>
            <div class="nav-tab" onclick="switchTab('workers')">
                <i class="fas fa-users"></i> Workers
            </div>
            <div class="nav-tab" onclick="switchTab('attendance')">
                <i class="fas fa-clipboard-check"></i> Attendance
            </div>
            <div class="nav-tab" onclick="switchTab('payroll')">
                <i class="fas fa-money-check-alt"></i> Payroll
            </div>
            <div class="nav-tab" onclick="switchTab('loans')">
                <i class="fas fa-hand-holding-usd"></i> Loans/Credit
            </div>
            <div class="nav-tab" onclick="switchTab('sites')">
                <i class="fas fa-map-marker-alt"></i> Sites
            </div>
            <div class="nav-tab" onclick="switchTab('expenses')">
                <i class="fas fa-receipt"></i> Expenses
            </div>
            <div class="nav-tab" onclick="switchTab('invoices')">
                <i class="fas fa-file-invoice"></i> Invoices
            </div>
        </nav>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
            <div class="section-header">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
                <select id="dashboardSiteFilter" onchange="updateDashboard()" style="width: 200px; padding: 8px 12px;">
                    <option value="all">All Sites</option>
                </select>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card stat-card">
                    <div class="stat-label">Total Workers</div>
                    <div id="totalWorkers" class="stat-number">0</div>
                    <div class="stat-sub">Active: <span id="activeWorkers">0</span></div>
                </div>

                <div class="dashboard-card stat-card">
                    <div class="stat-label">Active Sites</div>
                    <div id="activeSites" class="stat-number">0</div>
                    <div class="stat-sub">With workers assigned</div>
                </div>

                <div class="dashboard-card stat-card">
                    <div class="stat-label">Current Payroll</div>
                    <div id="currentPayroll" class="stat-number">R0</div>
                    <div class="stat-sub" id="payrollPeriod">This fortnight</div>
                </div>

                <div class="dashboard-card stat-card">
                    <div class="stat-label">Active Loans</div>
                    <div id="activeLoans" class="stat-number">R0</div>
                    <div class="stat-sub">Pending repayment</div>
                </div>
            </div>

            <div class="section-header">
                <h2><i class="fas fa-chart-pie"></i> Payroll Breakdown by Role</h2>
            </div>

            <div id="payrollBreakdown" class="card">
                <div class="loading"></div> Loading...
            </div>

            <div class="section-header">
                <h2><i class="fas fa-calendar-alt"></i> Active Fortnights</h2>
            </div>

            <div id="activeFortnights" class="card">
                <div class="loading"></div> Loading...
            </div>
        </section>

        <!-- Workers Section -->
        <section id="workers" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Workers Management</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showModal('workerModal')">
                        <i class="fas fa-plus"></i> Add Worker
                    </button>
                    <button class="btn btn-success" onclick="exportWorkersExcel()">
                        <i class="fas fa-file-excel"></i> Export
                    </button>
                    <button class="btn btn-warning" onclick="showModal('importExcelModal')">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Surname</th>
                            <th>Phone</th>
                            <th>Role</th>
                            <th>Daily Rate</th>
                            <th>Bank</th>
                            <th>Account</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="workersTableBody">
                        <!-- Workers will be populated here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Attendance Section -->
        <section id="attendance" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-clipboard-check"></i> Attendance Register</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showModal('fortnightModal')">
                        <i class="fas fa-calendar-plus"></i> New Fortnight
                    </button>
                    <button class="btn btn-warning" onclick="showModal('manageFortnightsModal')">
                        <i class="fas fa-calendar-alt"></i> Manage Fortnights
                    </button>
                    <button class="btn btn-success" onclick="saveAttendance()">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            </div>

            <div class="attendance-controls">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="attendanceSite">Site</label>
                    <select id="attendanceSite" onchange="loadAttendanceGrid()">
                        <option value="">Select Site</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label for="fortnightSelect">Fortnight</label>
                    <select id="fortnightSelect" onchange="loadAttendanceGrid()">
                        <option value="">Select Fortnight</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label>&nbsp;</label>
                    <button class="btn btn-success" onclick="showModal('addWorkersToSiteModal')">
                        <i class="fas fa-user-plus"></i> Add Workers
                    </button>
                </div>
            </div>

            <div class="attendance-actions">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div class="day-cell present" style="width: 24px; height: 24px;"></div>
                        <span>Present</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div class="day-cell absent" style="width: 24px; height: 24px;"></div>
                        <span>Absent</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <div style="width: 24px; height: 24px; background: white; border: 2px solid var(--border); border-radius: 6px;"></div>
                        <span>Not Marked</span>
                    </div>
                </div>
            </div>

            <div class="attendance-grid-container">
                <table class="attendance-grid" id="attendanceGrid">
                    <thead>
                        <tr id="attendanceHeader">
                            <!-- Dates will be populated here -->
                        </tr>
                    </thead>
                    <tbody id="attendanceBody">
                        <!-- Workers and attendance will be populated here -->
                    </tbody>
                </table>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>Attendance Summary</span>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="exportAttendancePDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-sm btn-success" onclick="exportAttendanceExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                    </div>
                </div>
                <div id="attendanceSummary">
                    <p>Select site and fortnight to view summary</p>
                </div>
            </div>
        </section>

        <!-- Payroll Section -->
        <section id="payroll" class="content-section">
            <div class="sub-tabs">
                <div class="sub-tab active" onclick="switchSubTab('payroll', 'calculate')">Calculate</div>
                <div class="sub-tab" onclick="switchSubTab('payroll', 'history')">History</div>
            </div>

            <div id="payroll-calculate" class="sub-tab-content">
                <div class="section-header">
                    <h2><i class="fas fa-calculator"></i> Calculate Payroll</h2>
                </div>

                <div class="attendance-controls">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="payrollSite">Site</label>
                        <select id="payrollSite" onchange="loadPayroll()">
                            <option value="">Select Site</option>
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="payrollFortnight">Fortnight</label>
                        <select id="payrollFortnight" onchange="loadPayroll()">
                            <option value="">Select Fortnight</option>
                        </select>
                    </div>

                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label>&nbsp;</label>
                        <button class="btn btn-success" onclick="calculatePayroll()">
                            <i class="fas fa-calculator"></i> Calculate
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="payrollTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Days</th>
                                <th>Rate</th>
                                <th>Gross</th>
                                <th>Loans</th>
                                <th>Credit</th>
                                <th>Net Pay</th>
                                <th>Bank</th>
                                <th>Account</th>
                            </tr>
                        </thead>
                        <tbody id="payrollTableBody">
                            <!-- Payroll will be populated here -->
                        </tbody>
                        <tfoot>
                            <tr id="payrollTotalRow">
                                <td colspan="4" style="text-align: right; font-weight: bold;">Total:</td>
                                <td id="totalGross">R0</td>
                                <td id="totalLoans">R0</td>
                                <td id="totalCredit">R0</td>
                                <td id="totalNet" style="font-weight: bold;">R0</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div style="text-align: right; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="exportPayrollPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="btn btn-success" onclick="savePayroll()">
                        <i class="fas fa-save"></i> Save Payroll
                    </button>
                </div>
            </div>

            <div id="payroll-history" class="sub-tab-content" style="display: none;">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Payroll History</h2>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Site</th>
                                <th>Fortnight</th>
                                <th>Workers</th>
                                <th>Total</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payrollHistoryBody">
                            <!-- Payroll history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Loans/Credit Section -->
        <section id="loans" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-hand-holding-usd"></i> Loans & Credit</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showModal('addLoanModal')">
                        <i class="fas fa-plus"></i> Add Loan/Credit
                    </button>
                </div>
            </div>

            <div class="sub-tabs">
                <div class="sub-tab active" onclick="switchSubTab('loans', 'loans')">Loans (They Owe Us)</div>
                <div class="sub-tab" onclick="switchSubTab('loans', 'credit')">Credit (We Owe Them)</div>
                <div class="sub-tab" onclick="switchSubTab('loans', 'all')">All Transactions</div>
            </div>

            <div id="loans-loans" class="sub-tab-content">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Worker</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Deduct</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loansTableBody">
                            <!-- Loans will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="loans-credit" class="sub-tab-content" style="display: none;">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Worker</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="creditTableBody">
                            <!-- Credit will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="loans-all" class="sub-tab-content" style="display: none;">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Worker</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allLoansTableBody">
                            <!-- All transactions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Sites Section -->
        <section id="sites" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-map-marker-alt"></i> Sites Management</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="showModal('siteModal')">
                        <i class="fas fa-plus"></i> Add Site
                    </button>
                </div>
            </div>

            <div class="sites-grid" id="sitesGrid">
                <!-- Sites will be populated here -->
            </div>
        </section>

        <!-- Expenses/Income Section -->
        <section id="expenses" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-receipt"></i> Expense & Income Tracker</h2>
                <div class="action-buttons">
                    <button class="btn btn-danger" onclick="showModal('expenseModal')">
                        <i class="fas fa-minus-circle"></i> Add Expense
                    </button>
                    <button class="btn btn-success" onclick="showModal('incomeModal')">
                        <i class="fas fa-plus-circle"></i> Add Income
                    </button>
                    <button class="btn btn-primary" onclick="exportTransactionsExcel()">
                        <i class="fas fa-file-excel"></i> Export
                    </button>
                </div>
            </div>

            <div class="attendance-controls">
                <div class="form-group" style="flex: 1; min-width: 150px;">
                    <select id="expenseTypeFilter" onchange="loadTransactions()">
                        <option value="all">All</option>
                        <option value="expense">Expenses</option>
                        <option value="income">Income</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 150px;">
                    <select id="expensePeriodFilter" onchange="loadTransactions()">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="fortnight">This Fortnight</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>

                <div class="form-group" style="flex: 1; min-width: 150px;">
                    <select id="expenseSiteFilter" onchange="loadTransactions()">
                        <option value="all">All Sites</option>
                    </select>
                </div>
            </div>

            <div class="dashboard-grid">
                <div style="grid-column: span 2;">
                    <div class="card">
                        <div class="card-header">Recent Transactions</div>
                        <div id="transactionsList">
                            <p>No transactions yet</p>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <div class="card-header">Summary</div>
                        <div style="padding: 15px;">
                            <div style="margin-bottom: 15px;">
                                <h4 style="color: var(--success);">Total Income</h4>
                                <div id="totalIncome" style="font-size: 1.5rem; font-weight: bold;">R0</div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <h4 style="color: var(--danger);">Total Expenses</h4>
                                <div id="totalExpenses" style="font-size: 1.5rem; font-weight: bold;">R0</div>
                            </div>

                            <div style="margin-bottom: 15px;">
                                <h4>Net Balance</h4>
                                <div id="netBalance" style="font-size: 1.5rem; font-weight: bold;">R0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Invoices Section -->
        <section id="invoices" class="content-section">
            <div class="section-header">
                <h2><i class="fas fa-file-invoice"></i> Invoice Generator</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="startNewInvoice()">
                        <i class="fas fa-plus"></i> New Invoice
                    </button>
                </div>
            </div>

            <div class="invoice-container">
                <div class="invoice-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoiceTo">Client Name *</label>
                            <input type="text" id="invoiceTo" placeholder="Client Name">
                        </div>
                        <div class="form-group">
                            <label for="invoiceNumber">Invoice # *</label>
                            <input type="text" id="invoiceNumber" placeholder="INV-001">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="invoiceAddress">Client Address *</label>
                        <textarea id="invoiceAddress" rows="2" placeholder="Client address"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoiceDate">Date</label>
                            <input type="date" id="invoiceDate">
                        </div>
                        <div class="form-group">
                            <label for="invoiceDueDate">Due Date</label>
                            <input type="date" id="invoiceDueDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Items</label>
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <input type="text" id="itemDesc" placeholder="Description">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <input type="number" id="itemQty" placeholder="Qty" value="1" min="1">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <input type="number" id="itemRate" placeholder="Rate" step="0.01">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <button class="btn btn-success" onclick="addInvoiceItem()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="invoiceItemsTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Rate</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceItemsTableBody">
                                <!-- Items will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <button class="btn btn-primary invoice-preview-btn" onclick="showInvoicePreview()">
                        <i class="fas fa-eye"></i> Preview Invoice
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Saved Invoices</div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Invoice #</th>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                            <!-- Invoices will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <!-- ====================== -->
    <!-- MODALS -->
    <!-- ====================== -->

    <!-- Worker Modal -->
    <div id="workerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add Worker</h3>
                <button class="close-modal" onclick="hideModal('workerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="workerName">First Name *</label>
                        <input type="text" id="workerName" required>
                    </div>
                    <div class="form-group">
                        <label for="workerSurname">Surname *</label>
                        <input type="text" id="workerSurname" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="workerPhone">Phone *</label>
                        <input type="tel" id="workerPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="workerRole">Role *</label>
                        <select id="workerRole" required>
                            <option value="">Select Role</option>
                            <option value="Bricklayer">Bricklayer</option>
                            <option value="Labourer">Labourer</option>
                            <option value="Plasterer">Plasterer</option>
                            <option value="Plaster Operator">Plaster Operator</option>
                            <option value="Plaster Labourer">Plaster Labourer</option>
                            <option value="Foreman">Foreman</option>
                            <option value="Transport">Transport</option>
                            <option value="Driver">Driver</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Office Admin">Office Admin</option>
                            <option value="Technician">Technician</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="workerRate">Daily Rate (R) *</label>
                        <input type="number" id="workerRate" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="workerBank">Bank *</label>
                        <select id="workerBank" required>
                            <option value="">Select Bank</option>
                            <option value="FNB">FNB</option>
                            <option value="Standard Bank">Standard Bank</option>
                            <option value="Absa">Absa</option>
                            <option value="Nedbank">Nedbank</option>
                            <option value="Capitec">Capitec</option>
                            <option value="Tymebank">Tymebank</option>
                            <option value="Bank Zero">Bank Zero</option>
                            <option value="Discovery Bank">Discovery Bank</option>
                            <option value="African Bank">African Bank</option>
                            <option value="Investec">Investec</option>
                            <option value="Bidvest Bank">Bidvest Bank</option>
                            <option value="Sasfin Bank">Sasfin Bank</option>
                            <option value="Grindrod Bank">Grindrod Bank</option>
                            <option value="Access Bank">Access Bank</option>
                            <option value="Bidvest Bank Alliances">Bidvest Bank Alliances</option>
                            <option value="Mercantile Bank">Mercantile Bank</option>
                            <option value="Ubank">Ubank</option>
                            <option value="Postbank">Postbank</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="workerAccount">Account # *</label>
                    <input type="text" id="workerAccount" required>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="workerActive" checked> Active Worker
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('workerModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveWorker()">Save Worker</button>
            </div>
        </div>
    </div>

    <!-- Edit Worker Modal -->
    <div id="editWorkerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-edit"></i> Edit Worker</h3>
                <button class="close-modal" onclick="hideModal('editWorkerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('editWorkerModal')">Cancel</button>
                <button class="btn btn-success" onclick="updateWorker()">Update Worker</button>
            </div>
        </div>
    </div>

    <!-- Add Loan/Credit Modal -->
    <div id="addLoanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-hand-holding-usd"></i> Add Loan/Credit</h3>
                <button class="close-modal" onclick="hideModal('addLoanModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="loanType">Type *</label>
                    <select id="loanType" required>
                        <option value="">Select Type</option>
                        <option value="loan">Loan (They Owe)</option>
                        <option value="credit">Credit (We Owe)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="loanWorker">Worker *</label>
                    <select id="loanWorker" required>
                        <option value="">Select Worker</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="loanAmount">Amount (R) *</label>
                        <input type="number" id="loanAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="loanDate">Date *</label>
                        <input type="date" id="loanDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="loanDescription">Description *</label>
                    <input type="text" id="loanDescription" placeholder="e.g., Advance payment" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="loanStatus">Status *</label>
                        <select id="loanStatus" required>
                            <option value="pending">Pending</option>
                            <option value="paid">Paid</option>
                            <option value="deducted">Deducted</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="loanDeduct" style="display: flex; align-items: center; gap: 8px; margin-top: 25px;">
                            <input type="checkbox" id="loanDeduct">
                            Deduct from payroll
                        </label>
                    </div>
                </div>

                <input type="hidden" id="loanEditId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('addLoanModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveLoan()">Save</button>
            </div>
        </div>
    </div>

    <!-- Site Modal -->
    <div id="siteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-map-marker-alt"></i> Add Site</h3>
                <button class="close-modal" onclick="hideModal('siteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="siteName">Site Name *</label>
                    <input type="text" id="siteName" placeholder="e.g., Paarl, Cape Town" required>
                </div>

                <div class="form-group">
                    <label for="siteAddress">Address</label>
                    <textarea id="siteAddress" rows="2" placeholder="Site address"></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="siteActive" checked> Active Site
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('siteModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveSite()">Save Site</button>
            </div>
        </div>
    </div>

    <!-- Edit Site Modal -->
    <div id="editSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Site</h3>
                <button class="close-modal" onclick="hideModal('editSiteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('editSiteModal')">Cancel</button>
                <button class="btn btn-success" onclick="updateSite()">Update Site</button>
            </div>
        </div>
    </div>

    <!-- Add Workers to Site Modal -->
    <div id="addWorkersToSiteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus"></i> Add Workers to Site</h3>
                <button class="close-modal" onclick="hideModal('addWorkersToSiteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="addWorkersSiteSelect">Select Site *</label>
                    <select id="addWorkersSiteSelect" onchange="updateAvailableWorkersList()">
                        <option value="">Select Site</option>
                    </select>
                </div>

                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="workerSearch" placeholder="Search workers..." onkeyup="filterWorkersList()">
                </div>

                <div class="worker-list-container" id="availableWorkersList">
                    <p>Select a site first</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('addWorkersToSiteModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveWorkersToSite()">Add Selected</button>
            </div>
        </div>
    </div>

    <!-- Fortnight Modal -->
    <div id="fortnightModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-plus"></i> Create Fortnight</h3>
                <button class="close-modal" onclick="hideModal('fortnightModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="fortnightSiteSelect">Site *</label>
                    <select id="fortnightSiteSelect" required>
                        <option value="">Select Site</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="fortnightStartDate">Start Date *</label>
                        <input type="date" id="fortnightStartDate" required onchange="updateFortnightEndDate()">
                    </div>
                    <div class="form-group">
                        <label for="fortnightEndDate">End Date</label>
                        <input type="date" id="fortnightEndDate" readonly style="background: #f0f0f0;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('fortnightModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveFortnight()">Create Fortnight</button>
            </div>
        </div>
    </div>

    <!-- Manage Fortnights Modal -->
    <div id="manageFortnightsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-alt"></i> Manage Fortnights</h3>
                <button class="close-modal" onclick="hideModal('manageFortnightsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Site</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fortnightsList">
                            <!-- Fortnights will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('manageFortnightsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Expense Modal -->
    <div id="expenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-minus-circle"></i> Add Expense</h3>
                <button class="close-modal" onclick="hideModal('expenseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="expenseSite">Site</label>
                    <select id="expenseSite">
                        <option value="">All Sites</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="expenseAmount">Amount (R) *</label>
                        <input type="number" id="expenseAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseDate">Date *</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="expenseCategory">Category *</label>
                    <select id="expenseCategory" required>
                        <option value="">Select Category</option>
                        <option value="petrol">Petrol</option>
                        <option value="equipment">Equipment</option>
                        <option value="vehicle">Vehicle Maintenance</option>
                        <option value="materials">Materials</option>
                        <option value="tools">Tools</option>
                        <option value="salaries">Salaries</option>
                        <option value="loan">Loan Repayment</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="expenseDescription">Description *</label>
                    <input type="text" id="expenseDescription" placeholder="e.g., Diesel for truck" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('expenseModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveExpense()">Save Expense</button>
            </div>
        </div>
    </div>

    <!-- Income Modal -->
    <div id="incomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Add Income</h3>
                <button class="close-modal" onclick="hideModal('incomeModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="incomeSite">Site</label>
                    <select id="incomeSite">
                        <option value="">All Sites</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="incomeAmount">Amount (R) *</label>
                        <input type="number" id="incomeAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="incomeDate">Date *</label>
                        <input type="date" id="incomeDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="incomeCategory">Category *</label>
                    <select id="incomeCategory" required>
                        <option value="">Select Category</option>
                        <option value="payment">Client Payment</option>
                        <option value="loan">Loan Payment</option>
                        <option value="advance">Advance Payment</option>
                        <option value="refund">Refund</option>
                        <option value="bonus">Bonus</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="incomeDescription">Description *</label>
                    <input type="text" id="incomeDescription" placeholder="e.g., Payment from client" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('incomeModal')">Cancel</button>
                <button class="btn btn-success" onclick="saveIncome()">Save Income</button>
            </div>
        </div>
    </div>

    <!-- Import Excel Modal -->
    <div id="importExcelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-import"></i> Import Workers</h3>
                <button class="close-modal" onclick="hideModal('importExcelModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="fas fa-info-circle"></i> Upload Excel file with columns: Name, Surname, Phone, Role, DailyRate, Bank, Account, Status
                </div>

                <div class="form-group">
                    <label for="excelFile">Select File *</label>
                    <input type="file" id="excelFile" accept=".xlsx,.xls">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('importExcelModal')">Cancel</button>
                <button class="btn btn-success" onclick="importWorkersExcel()">Import</button>
            </div>
        </div>
    </div>

    <!-- Restore Backup Modal -->
    <div id="restoreModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-upload"></i> Restore Backup</h3>
                <button class="close-modal" onclick="hideModal('restoreModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-triangle"></i> This will replace all current data!
                </div>

                <div class="form-group">
                    <label for="backupFile">Select Backup File</label>
                    <input type="file" id="backupFile" accept=".json">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('restoreModal')">Cancel</button>
                <button class="btn btn-success" onclick="restoreBackup()">Restore</button>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div id="invoicePreviewModal" class="modal invoice-preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> Invoice Preview</h3>
                <button class="close-modal" onclick="hideModal('invoicePreviewModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="invoice-preview-content" id="invoicePreviewContent">
                    <!-- Invoice preview will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="hideModal('invoicePreviewModal')">Close</button>
                <button class="btn btn-primary" onclick="generateInvoicePDF()">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </button>
                <button class="btn btn-success" onclick="saveInvoice()">
                    <i class="fas fa-save"></i> Save Invoice
                </button>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 3000; max-width: 400px;"></div>

    <script>
        // ======================
        // APPLICATION SETUP
        // ======================

        document.addEventListener('DOMContentLoaded', function () {
            initApp();
        });

        // Data structure
        let appData = {
            workers: [],
            sites: [],
            siteAssignments: [],
            fortnights: [],
            attendance: [],
            loans: [],
            expenses: [],
            payrolls: [],
            invoices: []
        };

        // Current state
        let currentState = {
            editWorkerId: null,
            editSiteId: null,
            editLoanId: null,
            invoiceItems: [],
            attendanceChanged: false
        };

        // Initialize app
        function initApp() {
            loadData();
            setupEventListeners();
            setDefaultDates();
            renderAll();

            updateSiteFilters();
            updateFortnightSelectors();

            showNotification('System loaded successfully!', 'success');
        }

        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem('tonnylaysData');
            if (savedData) {
                try {
                    appData = JSON.parse(savedData);
                    // Ensure all arrays exist
                    appData.workers = appData.workers || [];
                    appData.sites = appData.sites || [];
                    appData.siteAssignments = appData.siteAssignments || [];
                    appData.fortnights = appData.fortnights || [];
                    appData.attendance = appData.attendance || [];
                    appData.loans = appData.loans || [];
                    appData.expenses = appData.expenses || [];
                    appData.payrolls = appData.payrolls || [];
                    appData.invoices = appData.invoices || [];
                } catch (e) {
                    console.error('Error loading data:', e);
                    appData = {
                        workers: [], sites: [], siteAssignments: [], fortnights: [],
                        attendance: [], loans: [], expenses: [], payrolls: [], invoices: []
                    };
                }
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('tonnylaysData', JSON.stringify(appData));
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];

            // Set invoice dates
            document.getElementById('invoiceDate').value = today;
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];

            // Set expense/income dates
            document.getElementById('expenseDate').value = today;
            document.getElementById('incomeDate').value = today;

            // Set loan date
            document.getElementById('loanDate').value = today;

            // Set fortnight start date (next Wednesday)
            const date = new Date();
            const day = date.getDay();
            let daysToAdd;

            if (day <= 3) {
                daysToAdd = 3 - day;
            } else {
                daysToAdd = 10 - day;
            }

            date.setDate(date.getDate() + daysToAdd);
            const wednesday = date.toISOString().split('T')[0];
            document.getElementById('fortnightStartDate').value = wednesday;
            updateFortnightEndDate();

            // Generate invoice number
            updateInvoiceNumber();
        }

        // Update fortnight end date
        function updateFortnightEndDate() {
            const startDate = document.getElementById('fortnightStartDate').value;
            if (startDate) {
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 13);
                document.getElementById('fortnightEndDate').value = endDate.toISOString().split('T')[0];
            }
        }

        // Update invoice number
        function updateInvoiceNumber() {
            const count = appData.invoices.length + 1;
            document.getElementById('invoiceNumber').value = `INV-${count.toString().padStart(4, '0')}`;
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('fortnightStartDate').addEventListener('change', updateFortnightEndDate);
            document.getElementById('excelFile').addEventListener('change', handleExcelFileSelect);
        }

        // Handle Excel file selection
        function handleExcelFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Show preview count
                    const rowCount = jsonData.length - 1;
                    showNotification(`Found ${rowCount} rows to import`, 'success');
                } catch (error) {
                    showNotification('Error reading Excel file', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // ======================
        // NAVIGATION
        // ======================

        // Toggle mobile menu
        function toggleMobileMenu() {
            const mobileMenu = document.querySelector('.mobile-menu');
            mobileMenu.style.display = mobileMenu.style.display === 'none' ? 'grid' : 'none';
        }

        // Switch tab (desktop)
        function switchTab(tabId) {
            // Update desktop tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));

            // Activate selected tab
            const tabElement = document.querySelector(`.nav-tab[onclick="switchTab('${tabId}')"]`);
            if (tabElement) tabElement.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Update mobile menu
            updateMobileMenu(tabId);

            // Special handling for tabs
            if (tabId === 'dashboard') {
                updateDashboard();
            } else if (tabId === 'attendance') {
                loadAttendanceGrid();
            } else if (tabId === 'payroll') {
                loadPayroll();
            } else if (tabId === 'loans') {
                renderLoans();
            } else if (tabId === 'expenses') {
                loadTransactions();
            } else if (tabId === 'invoices') {
                renderInvoices();
            }
        }

        // Switch mobile tab
        function switchMobileTab(tabId) {
            switchTab(tabId);
            updateMobileMenu(tabId);
        }

        // Update mobile menu active state
        function updateMobileMenu(tabId) {
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => btn.classList.remove('active'));
            const mobileBtn = document.querySelector(`.mobile-nav-btn[onclick="switchMobileTab('${tabId}')"]`);
            if (mobileBtn) mobileBtn.classList.add('active');
        }

        // Switch sub-tab
        function switchSubTab(section, subTab) {
            // Hide all sub-tabs in this section
            document.querySelectorAll(`#${section} .sub-tab-content`).forEach(tab => tab.style.display = 'none');
            document.querySelectorAll(`#${section} .sub-tab`).forEach(tab => tab.classList.remove('active'));

            // Show selected sub-tab
            document.getElementById(`${section}-${subTab}`).style.display = 'block';
            event.target.classList.add('active');

            // Load data if needed
            if (section === 'payroll' && subTab === 'history') {
                renderPayrollHistory();
            }
        }

        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // Hide modal
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // ======================
        // NOTIFICATIONS
        // ======================

        // Show notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();

            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.id = alertId;
            alert.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="close-alert" onclick="document.getElementById('${alertId}').remove()">&times;</button>
            `;

            container.appendChild(alert);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (document.getElementById(alertId)) {
                    document.getElementById(alertId).remove();
                }
            }, 3000);
        }

        // ======================
        // DASHBOARD
        // ======================

        // Render all components
        function renderAll() {
            renderDashboard();
            renderWorkers();
            renderSites();
            updateSiteFilters();
            renderLoans();
            loadTransactions();
            renderInvoices();
        }

        // Render dashboard
        function renderDashboard() {
            // Update statistics
            const totalWorkers = appData.workers.length;
            const activeWorkers = appData.workers.filter(w => w.active).length;
            const activeSites = appData.sites.filter(s => s.active).length;

            document.getElementById('totalWorkers').textContent = totalWorkers;
            document.getElementById('activeWorkers').textContent = activeWorkers;
            document.getElementById('activeSites').textContent = activeSites;

            // Calculate current payroll from attendance
            let currentPayroll = 0;
            const today = new Date();
            
            // Get current fortnight
            let currentFortnight = null;
            for (const fortnight of appData.fortnights) {
                const start = new Date(fortnight.startDate);
                const end = new Date(fortnight.endDate);
                if (today >= start && today <= end) {
                    currentFortnight = fortnight;
                    break;
                }
            }

            if (currentFortnight) {
                // Calculate payroll for current fortnight
                const siteId = currentFortnight.siteId;
                const assignedWorkerIds = appData.siteAssignments
                    .filter(a => a.siteId === siteId && !a.endDate)
                    .map(a => a.workerId);

                assignedWorkerIds.forEach(workerId => {
                    const worker = appData.workers.find(w => w.id === workerId);
                    if (!worker || !worker.active) return;

                    // Count present days for this worker in current fortnight
                    let presentDays = 0;
                    const startDate = new Date(currentFortnight.startDate);
                    for (let i = 0; i < 14; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);
                        const dateStr = date.toISOString().split('T')[0];
                        
                        const attendance = appData.attendance.find(a =>
                            a.workerId === workerId &&
                            a.siteId === siteId &&
                            a.date === dateStr &&
                            a.status === 'P'
                        );
                        if (attendance) presentDays++;
                    }

                    currentPayroll += presentDays * worker.dailyRate;
                });

                const site = appData.sites.find(s => s.id === currentFortnight.siteId);
                document.getElementById('payrollPeriod').textContent = 
                    site ? `${site.name} - This fortnight` : 'This fortnight';
            }

            document.getElementById('currentPayroll').textContent = 'R' + currentPayroll.toLocaleString();

            // Calculate active loans
            const activeLoans = appData.loans
                .filter(l => l.type === 'loan' && l.status === 'pending')
                .reduce((sum, loan) => sum + loan.amount, 0);
            document.getElementById('activeLoans').textContent = 'R' + activeLoans.toLocaleString();

            // Update role breakdown
            updatePayrollBreakdown();
            updateActiveFortnights();
            updateDashboardSiteFilter();
        }

        // Update payroll breakdown by role
        function updatePayrollBreakdown() {
            const breakdownDiv = document.getElementById('payrollBreakdown');
            const siteId = document.getElementById('dashboardSiteFilter').value;

            let workers = appData.workers.filter(w => w.active);
            let payrollByRole = {};

            if (siteId && siteId !== 'all') {
                const assignedWorkerIds = appData.siteAssignments
                    .filter(a => a.siteId === siteId && !a.endDate)
                    .map(a => a.workerId);
                workers = workers.filter(w => assignedWorkerIds.includes(w.id));
            }

            // Calculate actual payroll from attendance
            workers.forEach(worker => {
                if (!payrollByRole[worker.role]) {
                    payrollByRole[worker.role] = {
                        count: 0,
                        totalPayroll: 0,
                        workers: []
                    };
                }
                payrollByRole[worker.role].count++;
                payrollByRole[worker.role].workers.push(worker);

                // Calculate actual payroll for this worker from attendance
                let workerPayroll = 0;
                appData.attendance.forEach(att => {
                    if (att.workerId === worker.id && att.status === 'P') {
                        workerPayroll += worker.dailyRate;
                    }
                });
                payrollByRole[worker.role].totalPayroll += workerPayroll;
            });

            // Sort roles by total payroll (descending)
            const sortedRoles = Object.keys(payrollByRole).sort((a, b) => 
                payrollByRole[b].totalPayroll - payrollByRole[a].totalPayroll
            );

            if (sortedRoles.length === 0) {
                breakdownDiv.innerHTML = '<p>No workers found</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">';

            sortedRoles.forEach(role => {
                const data = payrollByRole[role];
                html += `
                    <div style="background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid var(--secondary);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div style="font-weight: bold; color: var(--primary); font-size: 1.1rem;">${role}</div>
                            <div style="font-size: 0.9rem; color: var(--dark);">${data.count} workers</div>
                        </div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--success); margin: 10px 0;">
                            R${data.totalPayroll.toLocaleString()}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--dark);">
                            Actual payroll from attendance records
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            breakdownDiv.innerHTML = html;
        }

        // Update active fortnights
        function updateActiveFortnights() {
            const container = document.getElementById('activeFortnights');
            const today = new Date();

            const activeFortnights = appData.fortnights.filter(f => {
                const end = new Date(f.endDate);
                return end >= today;
            }).sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            if (activeFortnights.length === 0) {
                container.innerHTML = '<p>No active fortnights</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">';

            activeFortnights.forEach(fortnight => {
                const site = appData.sites.find(s => s.id === fortnight.siteId);
                if (!site) return;

                // Count workers assigned to this site
                const workerCount = appData.siteAssignments
                    .filter(a => a.siteId === fortnight.siteId && !a.endDate)
                    .length;

                // Count attendance for this fortnight
                let presentCount = 0;
                appData.attendance.forEach(att => {
                    if (att.siteId === fortnight.siteId && 
                        att.date >= fortnight.startDate && 
                        att.date <= fortnight.endDate && 
                        att.status === 'P') {
                        presentCount++;
                    }
                });

                html += `
                    <div style="background: white; border-radius: 10px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: bold; color: var(--primary);">${site.name}</div>
                                <div style="font-size: 0.9rem; color: var(--dark); margin-top: 5px;">
                                    ${formatDate(fortnight.startDate)} - ${formatDate(fortnight.endDate)}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: var(--success);">${workerCount} workers</div>
                                <div style="font-size: 0.9rem; color: var(--dark);">${presentCount} present days</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Update dashboard when site filter changes
        function updateDashboard() {
            updatePayrollBreakdown();
        }

        // Update dashboard site filter
        function updateDashboardSiteFilter() {
            const filter = document.getElementById('dashboardSiteFilter');
            const currentValue = filter.value;

            filter.innerHTML = '<option value="all">All Sites</option>';
            appData.sites
                .filter(s => s.active)
                .forEach(site => {
                    const option = document.createElement('option');
                    option.value = site.id;
                    option.textContent = site.name;
                    filter.appendChild(option);
                });

            if (currentValue) filter.value = currentValue;
        }

        // ======================
        // WORKER MANAGEMENT
        // ======================

        // Save new worker
        function saveWorker() {
            const name = document.getElementById('workerName').value.trim();
            const surname = document.getElementById('workerSurname').value.trim();
            const phone = document.getElementById('workerPhone').value.trim();
            const role = document.getElementById('workerRole').value;
            const dailyRate = parseFloat(document.getElementById('workerRate').value);
            const bank = document.getElementById('workerBank').value;
            const account = document.getElementById('workerAccount').value.trim();
            const active = document.getElementById('workerActive').checked;

            // Validate
            if (!name || !surname || !phone || !role || !dailyRate || !bank || !account) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (dailyRate <= 0) {
                showNotification('Daily rate must be higher than 0', 'error');
                return;
            }

            // Add worker
            const worker = {
                id: generateId(),
                name,
                surname,
                phone,
                role,
                dailyRate,
                bank,
                account,
                active,
                createdAt: new Date().toISOString()
            };

            appData.workers.push(worker);
            saveData();
            renderWorkers();
            hideModal('workerModal');
            showNotification('Worker added successfully', 'success');
        }

        // Show edit worker modal
        function showEditWorkerModal(workerId) {
            const worker = appData.workers.find(w => w.id === workerId);
            if (!worker) return;

            currentState.editWorkerId = workerId;

            const modalBody = document.querySelector('#editWorkerModal .modal-body');
            modalBody.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" id="editWorkerName" value="${worker.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Surname *</label>
                        <input type="text" id="editWorkerSurname" value="${worker.surname}" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" id="editWorkerPhone" value="${worker.phone}" required>
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select id="editWorkerRole" required>
                            ${getRoleOptions(worker.role)}
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Daily Rate (R) *</label>
                        <input type="number" id="editWorkerRate" value="${worker.dailyRate}" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Bank *</label>
                        <select id="editWorkerBank" required>
                            ${getBankOptions(worker.bank)}
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Account # *</label>
                    <input type="text" id="editWorkerAccount" value="${worker.account}" required>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editWorkerActive" ${worker.active ? 'checked' : ''}> Active Worker
                    </label>
                </div>
            `;

            showModal('editWorkerModal');
        }

        // Get role options HTML
        function getRoleOptions(selectedRole) {
            const roles = ['Bricklayer', 'Labourer', 'Plasterer', 'Plaster Operator', 'Plaster Labourer',
                'Foreman', 'Transport', 'Driver', 'Supervisor', 'Office Admin', 'Technician'];

            return '<option value="">Select Role</option>' +
                roles.map(role =>
                    `<option value="${role}" ${role === selectedRole ? 'selected' : ''}>${role}</option>`
                ).join('');
        }

        // Get bank options HTML
        function getBankOptions(selectedBank) {
            const banks = ['FNB', 'Standard Bank', 'Absa', 'Nedbank', 'Capitec', 'Tymebank',
                'Bank Zero', 'Discovery Bank', 'African Bank', 'Investec',
                'Bidvest Bank', 'Sasfin Bank', 'Grindrod Bank', 'Access Bank', 
                'Bidvest Bank Alliances', 'Mercantile Bank', 'Ubank', 'Postbank', 'Other'];

            return '<option value="">Select Bank</option>' +
                banks.map(bank =>
                    `<option value="${bank}" ${bank === selectedBank ? 'selected' : ''}>${bank}</option>`
                ).join('');
        }

        // Update existing worker
        function updateWorker() {
            const worker = appData.workers.find(w => w.id === currentState.editWorkerId);
            if (!worker) return;

            worker.name = document.getElementById('editWorkerName').value.trim();
            worker.surname = document.getElementById('editWorkerSurname').value.trim();
            worker.phone = document.getElementById('editWorkerPhone').value.trim();
            worker.role = document.getElementById('editWorkerRole').value;
            worker.dailyRate = parseFloat(document.getElementById('editWorkerRate').value);
            worker.bank = document.getElementById('editWorkerBank').value;
            worker.account = document.getElementById('editWorkerAccount').value.trim();
            worker.active = document.getElementById('editWorkerActive').checked;
            worker.updatedAt = new Date().toISOString();

            saveData();
            renderWorkers();
            hideModal('editWorkerModal');
            showNotification('Worker updated successfully', 'success');

            currentState.editWorkerId = null;
        }

        // Render workers table
        function renderWorkers() {
            const tbody = document.getElementById('workersTableBody');
            tbody.innerHTML = '';

            // Sort workers by role, then surname, then name
            const sortedWorkers = [...appData.workers].sort((a, b) => {
                if (a.role !== b.role) return a.role.localeCompare(b.role);
                if (a.surname !== b.surname) return a.surname.localeCompare(b.surname);
                return a.name.localeCompare(b.name);
            });

            sortedWorkers.forEach(worker => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${worker.name}</td>
                    <td>${worker.surname}</td>
                    <td>${worker.phone}</td>
                    <td>${worker.role}</td>
                    <td>R${worker.dailyRate.toLocaleString()}</td>
                    <td>${worker.bank}</td>
                    <td>${worker.account}</td>
                    <td><span class="status-badge ${worker.active ? 'status-active' : 'status-inactive'}">${worker.active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="showEditWorkerModal('${worker.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteWorker('${worker.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Delete worker
        function deleteWorker(workerId) {
            if (!confirm('Are you sure you want to delete this worker?')) return;

            const worker = appData.workers.find(w => w.id === workerId);
            if (!worker) return;

            // Check if worker has records
            const hasLoans = appData.loans.some(l => l.workerId === workerId);
            const hasAttendance = appData.attendance.some(a => a.workerId === workerId);

            if (hasLoans || hasAttendance) {
                if (!confirm('Worker has records. Deactivate instead?')) return;
                worker.active = false;
                saveData();
                renderWorkers();
                showNotification('Worker deactivated', 'success');
                return;
            }

            // Remove worker
            appData.workers = appData.workers.filter(w => w.id !== workerId);

            // Remove site assignments
            appData.siteAssignments = appData.siteAssignments.filter(a => a.workerId !== workerId);

            saveData();
            renderWorkers();
            showNotification('Worker deleted successfully', 'success');
        }

        // Export workers to Excel
        function exportWorkersExcel() {
            const data = appData.workers.map(worker => [
                worker.name,
                worker.surname,
                worker.phone,
                worker.role,
                worker.dailyRate,
                worker.bank,
                worker.account,
                worker.active ? 'Active' : 'Inactive'
            ]);

            const ws = XLSX.utils.aoa_to_sheet([
                ['Name', 'Surname', 'Phone', 'Role', 'Daily Rate', 'Bank', 'Account', 'Status'],
                ...data
            ]);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Workers');
            XLSX.writeFile(wb, `Tonnylays_Workers_${new Date().toISOString().split('T')[0]}.xlsx`);

            showNotification('Workers exported successfully', 'success');
        }

        // Import workers from Excel
        function importWorkersExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('Please select an Excel file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Skip header
                    const rows = jsonData.slice(1);
                    let imported = 0;
                    let skipped = 0;

                    rows.forEach(row => {
                        if (row.length >= 8) {
                            const [name, surname, phone, role, dailyRate, bank, account, status] = row;

                            // Validate required fields
                            if (!name || !surname || !role) {
                                skipped++;
                                return;
                            }

                            // Add worker with unique ID
                            const worker = {
                                id: generateId(),
                                name: name.toString(),
                                surname: surname.toString(),
                                phone: phone ? phone.toString() : '',
                                role: role.toString(),
                                dailyRate: parseFloat(dailyRate) || 0,
                                bank: bank ? bank.toString() : 'Other',
                                account: account ? account.toString() : '',
                                active: status ? (status === 'Active' || status === 'active' || status === true) : true,
                                createdAt: new Date().toISOString()
                            };

                            appData.workers.push(worker);
                            imported++;
                        }
                    });

                    saveData();
                    renderWorkers();
                    hideModal('importExcelModal');
                    showNotification(`Imported ${imported} workers, skipped ${skipped}`, 'success');

                    // Clear file input
                    fileInput.value = '';

                } catch (error) {
                    showNotification('Error importing file: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // ======================
        // SITE MANAGEMENT
        // ======================

        // Render sites
        function renderSites() {
            const grid = document.getElementById('sitesGrid');
            grid.innerHTML = '';

            appData.sites.forEach(site => {
                // Get assigned workers
                const assignedWorkerIds = appData.siteAssignments
                    .filter(a => a.siteId === site.id && !a.endDate)
                    .map(a => a.workerId);

                const assignedWorkers = appData.workers
                    .filter(w => assignedWorkerIds.includes(w.id))
                    .sort((a, b) => {
                        if (a.role !== b.role) return a.role.localeCompare(b.role);
                        return a.surname.localeCompare(b.surname);
                    });

                const siteCard = document.createElement('div');
                siteCard.className = 'site-card';
                siteCard.innerHTML = `
                    <div class="site-card-header">
                        <div class="site-name">${site.name}</div>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="showEditSiteModal('${site.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSite('${site.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    ${site.address ? `<div style="font-size: 0.9rem; color: var(--dark); margin-bottom: 10px;">${site.address}</div>` : ''}
                    
                    <div style="font-size: 0.9rem; margin-bottom: 10px;">
                        <strong>Workers assigned:</strong> ${assignedWorkerIds.length}
                    </div>
                    
                    ${assignedWorkers.length > 0 ? `
                        <div class="site-workers-list">
                            ${assignedWorkers.map(w => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee;">
                                    <div>
                                        <span style="font-weight: 500;">${w.name} ${w.surname}</span>
                                        <span style="font-size: 0.8rem; color: var(--dark); margin-left: 8px;">(${w.role})</span>
                                    </div>
                                    <button class="btn btn-sm btn-danger" style="padding: 2px 8px; font-size: 0.7rem;" onclick="removeWorkerFromSite('${site.id}', '${w.id}')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div style="text-align: center; padding: 10px; color: var(--dark);">No workers assigned</div>'}
                    
                    <div style="margin-top: 15px; text-align: center;">
                        <button class="btn btn-sm btn-success" onclick="assignWorkersToSite('${site.id}')">
                            <i class="fas fa-user-plus"></i> Add Workers
                        </button>
                    </div>
                `;

                grid.appendChild(siteCard);
            });
        }

        // Show edit site modal
        function showEditSiteModal(siteId) {
            const site = appData.sites.find(s => s.id === siteId);
            if (!site) return;

            currentState.editSiteId = siteId;

            const modalBody = document.querySelector('#editSiteModal .modal-body');
            modalBody.innerHTML = `
                <div class="form-group">
                    <label>Site Name *</label>
                    <input type="text" id="editSiteName" value="${site.name}" required>
                </div>
                
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="editSiteAddress" rows="2">${site.address || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editSiteActive" ${site.active ? 'checked' : ''}> Active Site
                    </label>
                </div>
            `;

            showModal('editSiteModal');
        }

        // Save new site
        function saveSite() {
            const name = document.getElementById('siteName').value.trim();
            const address = document.getElementById('siteAddress').value.trim();
            const active = document.getElementById('siteActive').checked;

            if (!name) {
                showNotification('Site name is required', 'error');
                return;
            }

            const site = {
                id: generateId(),
                name,
                address,
                active,
                createdAt: new Date().toISOString()
            };

            appData.sites.push(site);
            saveData();
            renderSites();
            updateSiteFilters();
            hideModal('siteModal');
            showNotification('Site added successfully', 'success');
        }

        // Update site
        function updateSite() {
            const site = appData.sites.find(s => s.id === currentState.editSiteId);
            if (!site) return;

            site.name = document.getElementById('editSiteName').value.trim();
            site.address = document.getElementById('editSiteAddress').value.trim();
            site.active = document.getElementById('editSiteActive').checked;
            site.updatedAt = new Date().toISOString();

            saveData();
            renderSites();
            updateSiteFilters();
            hideModal('editSiteModal');
            showNotification('Site updated successfully', 'success');

            currentState.editSiteId = null;
        }

        // Delete site
        function deleteSite(siteId) {
            if (!confirm('Are you sure? This will also remove all attendance and payroll data for this site.')) return;

            // Remove site
            appData.sites = appData.sites.filter(s => s.id !== siteId);

            // Remove related data
            appData.siteAssignments = appData.siteAssignments.filter(a => a.siteId !== siteId);
            appData.fortnights = appData.fortnights.filter(f => f.siteId !== siteId);
            appData.attendance = appData.attendance.filter(a => a.siteId !== siteId);

            saveData();
            renderSites();
            updateSiteFilters();
            showNotification('Site deleted successfully', 'success');
        }

        // Remove worker from site
        function removeWorkerFromSite(siteId, workerId) {
            if (!confirm('Remove this worker from site?')) return;

            const assignment = appData.siteAssignments.find(a => 
                a.siteId === siteId && 
                a.workerId === workerId && 
                !a.endDate
            );

            if (assignment) {
                assignment.endDate = new Date().toISOString().split('T')[0];
                saveData();
                renderSites();
                showNotification('Worker removed from site', 'success');
            }
        }

        // Update site filters in dropdowns
        function updateSiteFilters() {
            const selectors = [
                'dashboardSiteFilter',
                'attendanceSite',
                'payrollSite',
                'addWorkersSiteSelect',
                'fortnightSiteSelect',
                'expenseSiteFilter',
                'expenseSite',
                'incomeSite'
            ];

            selectors.forEach(selectorId => {
                const select = document.getElementById(selectorId);
                if (select) {
                    const currentValue = select.value;
                    const isAllSites = selectorId.includes('Filter') || selectorId === 'expenseSite' || selectorId === 'incomeSite';

                    select.innerHTML = isAllSites ? '<option value="all">All Sites</option>' : '<option value="">Select Site</option>';

                    appData.sites
                        .filter(s => s.active)
                        .forEach(site => {
                            const option = document.createElement('option');
                            option.value = site.id;
                            option.textContent = site.name;
                            select.appendChild(option);
                        });

                    if (currentValue && Array.from(select.options).some(opt => opt.value === currentValue)) {
                        select.value = currentValue;
                    }
                }
            });
        }

        // ======================
        // ATTENDANCE MANAGEMENT
        // ======================

        // Load attendance grid
        function loadAttendanceGrid() {
            const siteId = document.getElementById('attendanceSite').value;
            const fortnightId = document.getElementById('fortnightSelect').value;

            if (!siteId || !fortnightId) {
                clearAttendanceGrid();
                return;
            }

            const fortnight = appData.fortnights.find(f => f.id === fortnightId);
            if (!fortnight) return;

            // Generate dates
            const dates = [];
            const currentDate = new Date(fortnight.startDate);
            for (let i = 0; i < 14; i++) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Update header
            updateAttendanceHeader(dates);

            // Get assigned workers sorted by role then name
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            const assignedWorkers = appData.workers
                .filter(w => assignedWorkerIds.includes(w.id) && w.active)
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    if (a.surname !== b.surname) return a.surname.localeCompare(b.surname);
                    return a.name.localeCompare(b.name);
                });

            // Populate attendance body
            updateAttendanceBody(assignedWorkers, siteId, fortnightId, dates);

            // Update summary
            updateAttendanceSummary(siteId, fortnightId, assignedWorkers, dates);
        }

        // Clear attendance grid
        function clearAttendanceGrid() {
            document.getElementById('attendanceHeader').innerHTML = '<th class="worker-name">Worker</th>';
            document.getElementById('attendanceBody').innerHTML = '<tr><td colspan="15" style="text-align: center; padding: 20px;">Select site and fortnight</td></tr>';
            document.getElementById('attendanceSummary').innerHTML = '<p>Select site and fortnight to view summary</p>';
        }

        // Update attendance header
        function updateAttendanceHeader(dates) {
            const headerRow = document.getElementById('attendanceHeader');
            headerRow.innerHTML = '<th class="worker-name">Worker</th>';

            dates.forEach(dateStr => {
                const th = document.createElement('th');
                th.textContent = formatDateShort(dateStr);
                th.title = formatDate(dateStr);
                headerRow.appendChild(th);
            });
        }

        // Update attendance body
        function updateAttendanceBody(workers, siteId, fortnightId, dates) {
            const attendanceBody = document.getElementById('attendanceBody');
            attendanceBody.innerHTML = '';

            if (workers.length === 0) {
                attendanceBody.innerHTML = `
                    <tr>
                        <td colspan="15" style="text-align: center; padding: 20px;">
                            No workers assigned. Click "Add Workers" to assign workers to this site.
                        </td>
                    </tr>
                `;
                return;
            }

            workers.forEach(worker => {
                const row = document.createElement('tr');
                row.className = 'worker-row';

                // Worker name cell
                const nameCell = document.createElement('td');
                nameCell.className = 'worker-name';
                nameCell.textContent = `${worker.name} ${worker.surname}`;
                nameCell.title = `${worker.role} - R${worker.dailyRate}/day`;
                row.appendChild(nameCell);

                // Attendance cells
                dates.forEach(dateStr => {
                    const cell = document.createElement('td');
                    cell.className = 'day-cell';
                    cell.dataset.workerId = worker.id;
                    cell.dataset.date = dateStr;
                    cell.dataset.siteId = siteId;
                    cell.onclick = () => toggleAttendance(cell);

                    // Get existing attendance
                    const existingAttendance = appData.attendance.find(a =>
                        a.workerId === worker.id &&
                        a.siteId === siteId &&
                        a.date === dateStr
                    );

                    if (existingAttendance) {
                        cell.textContent = existingAttendance.status;
                        cell.classList.add(existingAttendance.status === 'P' ? 'present' : 'absent');
                    }

                    row.appendChild(cell);
                });

                attendanceBody.appendChild(row);
            });
        }

        // Toggle attendance status
        function toggleAttendance(cell) {
            const workerId = cell.dataset.workerId;
            const date = cell.dataset.date;
            const siteId = cell.dataset.siteId;

            // Cycle status: empty  P  A  empty
            const currentStatus = cell.textContent;
            let newStatus = '';

            if (currentStatus === '') {
                newStatus = 'P';
                cell.classList.add('present');
                cell.classList.remove('absent');
            } else if (currentStatus === 'P') {
                newStatus = 'A';
                cell.classList.remove('present');
                cell.classList.add('absent');
            }

            cell.textContent = newStatus;

            // Update or create attendance record
            const existingIndex = appData.attendance.findIndex(a =>
                a.workerId === workerId &&
                a.siteId === siteId &&
                a.date === date
            );

            if (newStatus === '') {
                // Remove if clearing
                if (existingIndex !== -1) {
                    appData.attendance.splice(existingIndex, 1);
                }
            } else {
                const attendanceRecord = {
                    id: existingIndex !== -1 ? appData.attendance[existingIndex].id : generateId(),
                    workerId,
                    siteId,
                    date,
                    status: newStatus,
                    createdAt: new Date().toISOString()
                };

                if (existingIndex !== -1) {
                    appData.attendance[existingIndex] = attendanceRecord;
                } else {
                    appData.attendance.push(attendanceRecord);
                }
            }

            currentState.attendanceChanged = true;
            updateAttendanceSummaryFromUI();
        }

        // Save attendance
        function saveAttendance() {
            if (!currentState.attendanceChanged) {
                showNotification('No changes to save', 'info');
                return;
            }

            saveData();
            currentState.attendanceChanged = false;
            showNotification('Attendance saved successfully', 'success');
        }

        // Update attendance summary from UI
        function updateAttendanceSummaryFromUI() {
            const siteId = document.getElementById('attendanceSite').value;
            const fortnightId = document.getElementById('fortnightSelect').value;

            if (!siteId || !fortnightId) return;

            const fortnight = appData.fortnights.find(f => f.id === fortnightId);
            if (!fortnight) return;

            // Generate dates
            const dates = [];
            const currentDate = new Date(fortnight.startDate);
            for (let i = 0; i < 14; i++) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Get assigned workers
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            const assignedWorkers = appData.workers
                .filter(w => assignedWorkerIds.includes(w.id) && w.active);

            updateAttendanceSummary(siteId, fortnightId, assignedWorkers, dates);
        }

        // Update attendance summary
        function updateAttendanceSummary(siteId, fortnightId, workers, dates) {
            const summaryDiv = document.getElementById('attendanceSummary');

            if (workers.length === 0) {
                summaryDiv.innerHTML = '<p>No workers assigned</p>';
                return;
            }

            let presentCount = 0;
            let absentCount = 0;
            let totalPayroll = 0;

            // Count attendance from data
            workers.forEach(worker => {
                dates.forEach(date => {
                    const attendance = appData.attendance.find(a =>
                        a.workerId === worker.id &&
                        a.siteId === siteId &&
                        a.date === date
                    );

                    if (attendance) {
                        if (attendance.status === 'P') {
                            presentCount++;
                            totalPayroll += worker.dailyRate;
                        } else if (attendance.status === 'A') {
                            absentCount++;
                        }
                    }
                });
            });

            const totalSlots = workers.length * dates.length;
            const notMarkedCount = totalSlots - presentCount - absentCount;

            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 15px; border-radius: 8px; text-align: center; color: white;">
                        <div style="font-size: 2rem; font-weight: bold;">${presentCount}</div>
                        <div>Present</div>
                    </div>
                    <div style="background: linear-gradient(135deg, var(--danger), #fc8181); padding: 15px; border-radius: 8px; text-align: center; color: white;">
                        <div style="font-size: 2rem; font-weight: bold;">${absentCount}</div>
                        <div>Absent</div>
                    </div>
                    <div style="background: linear-gradient(135deg, var(--warning), #ed8936); padding: 15px; border-radius: 8px; text-align: center; color: white;">
                        <div style="font-size: 2rem; font-weight: bold;">${notMarkedCount}</div>
                        <div>Not Marked</div>
                    </div>
                    <div style="background: linear-gradient(135deg, var(--success), #48bb78); padding: 15px; border-radius: 8px; text-align: center; color: white;">
                        <div style="font-size: 2rem; font-weight: bold;">R${totalPayroll.toLocaleString()}</div>
                        <div>Total Payroll</div>
                    </div>
                </div>
            `;

            summaryDiv.innerHTML = html;
        }

        // Assign workers to site
        function assignWorkersToSite(siteId) {
            // Set site in dropdown
            document.getElementById('addWorkersSiteSelect').value = siteId;
            updateAvailableWorkersList();
            showModal('addWorkersToSiteModal');
        }

        // Filter workers list
        function filterWorkersList() {
            const searchTerm = document.getElementById('workerSearch').value.toLowerCase();
            const workerItems = document.querySelectorAll('.worker-list-item');
            
            workerItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Update available workers list
        function updateAvailableWorkersList() {
            const siteId = document.getElementById('addWorkersSiteSelect').value;
            const workersListDiv = document.getElementById('availableWorkersList');

            if (!siteId) {
                workersListDiv.innerHTML = '<p>Select a site first</p>';
                return;
            }

            // Get workers already assigned
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            // Get available workers (active and not assigned) sorted by role then surname
            const availableWorkers = appData.workers
                .filter(w => w.active && !assignedWorkerIds.includes(w.id))
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    if (a.surname !== b.surname) return a.surname.localeCompare(b.surname);
                    return a.name.localeCompare(b.name);
                });

            if (availableWorkers.length === 0) {
                workersListDiv.innerHTML = '<p>No available workers</p>';
                return;
            }

            let html = '';
            availableWorkers.forEach(worker => {
                html += `
                    <div class="worker-list-item">
                        <input type="checkbox" class="worker-checkbox" value="${worker.id}">
                        <div class="worker-info">
                            <div style="font-weight: bold;">${worker.name} ${worker.surname}</div>
                            <div class="worker-role">${worker.role} - R${worker.dailyRate}/day</div>
                        </div>
                    </div>
                `;
            });

            workersListDiv.innerHTML = html;
        }

        // Save workers to site
        function saveWorkersToSite() {
            const siteId = document.getElementById('addWorkersSiteSelect').value;

            if (!siteId) {
                showNotification('Please select a site', 'error');
                return;
            }

            const checkboxes = document.querySelectorAll('.worker-checkbox:checked');

            if (checkboxes.length === 0) {
                showNotification('Please select at least one worker', 'error');
                return;
            }

            let addedCount = 0;
            checkboxes.forEach(checkbox => {
                const workerId = checkbox.value;

                // Check if already assigned
                const existing = appData.siteAssignments.find(a =>
                    a.workerId === workerId &&
                    a.siteId === siteId &&
                    !a.endDate
                );

                if (!existing) {
                    const assignment = {
                        id: generateId(),
                        workerId,
                        siteId,
                        startDate: new Date().toISOString().split('T')[0],
                        endDate: null,
                        createdAt: new Date().toISOString()
                    };

                    appData.siteAssignments.push(assignment);
                    addedCount++;
                }
            });

            saveData();
            renderSites();

            // Update attendance grid if viewing this site
            const currentSite = document.getElementById('attendanceSite').value;
            if (currentSite === siteId) {
                loadAttendanceGrid();
            }

            hideModal('addWorkersToSiteModal');
            showNotification(`Added ${addedCount} workers to site`, 'success');
        }

        // ======================
        // FORTNIGHT MANAGEMENT
        // ======================

        // Save fortnight
        function saveFortnight() {
            const siteId = document.getElementById('fortnightSiteSelect').value;
            const startDate = document.getElementById('fortnightStartDate').value;
            const endDate = document.getElementById('fortnightEndDate').value;

            if (!siteId || !startDate) {
                showNotification('Please select site and start date', 'error');
                return;
            }

            // Check for overlapping fortnights
            const overlapping = appData.fortnights.find(f =>
                f.siteId === siteId &&
                ((new Date(startDate) >= new Date(f.startDate) && new Date(startDate) <= new Date(f.endDate)) ||
                    (new Date(endDate) >= new Date(f.startDate) && new Date(endDate) <= new Date(f.endDate)))
            );

            if (overlapping) {
                showNotification('Fortnight overlaps with existing fortnight', 'error');
                return;
            }

            const fortnight = {
                id: generateId(),
                siteId,
                startDate,
                endDate,
                createdAt: new Date().toISOString()
            };

            appData.fortnights.push(fortnight);
            saveData();

            // Update dropdowns
            updateFortnightSelectors();
            hideModal('fortnightModal');
            showNotification('Fortnight created successfully', 'success');

            // Auto-select the new fortnight
            document.getElementById('attendanceSite').value = siteId;
            document.getElementById('fortnightSelect').value = fortnight.id;

            // Load attendance grid
            setTimeout(() => {
                loadAttendanceGrid();
                switchTab('attendance');
            }, 100);
        }

        // Update fortnight selectors
        function updateFortnightSelectors() {
            // Handle attendance fortnight selector - filter by selected site
            const attendanceSiteSelect = document.getElementById('attendanceSite');
            const fortnightSelect = document.getElementById('fortnightSelect');

            if (attendanceSiteSelect && fortnightSelect) {
                const selectedSiteId = attendanceSiteSelect.value;
                const currentValue = fortnightSelect.value;

                fortnightSelect.innerHTML = '<option value="">Select Fortnight</option>';

                if (selectedSiteId) {
                    // Filter fortnights by selected site
                    const siteFortnights = appData.fortnights
                        .filter(f => f.siteId === selectedSiteId)
                        .sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

                    siteFortnights.forEach(fortnight => {
                        const site = appData.sites.find(s => s.id === fortnight.siteId);
                        if (!site) return;

                        const option = document.createElement('option');
                        option.value = fortnight.id;
                        option.textContent = `${formatDate(fortnight.startDate)} - ${formatDate(fortnight.endDate)}`;
                        fortnightSelect.appendChild(option);
                    });

                    // Restore previous selection if it exists and belongs to this site
                    if (currentValue && siteFortnights.some(f => f.id === currentValue)) {
                        fortnightSelect.value = currentValue;
                    }
                }
            }

            // Handle payroll fortnight selector - show all fortnights
            const payrollFortnight = document.getElementById('payrollFortnight');
            if (payrollFortnight) {
                const currentValue = payrollFortnight.value;

                payrollFortnight.innerHTML = '<option value="">Select Fortnight</option>';

                appData.fortnights
                    .sort((a, b) => new Date(b.startDate) - new Date(a.startDate))
                    .forEach(fortnight => {
                        const site = appData.sites.find(s => s.id === fortnight.siteId);
                        if (!site) return;

                        const option = document.createElement('option');
                        option.value = fortnight.id;
                        option.textContent = `${site.name} (${formatDate(fortnight.startDate)} - ${formatDate(fortnight.endDate)})`;
                        payrollFortnight.appendChild(option);
                    });

                if (currentValue && Array.from(payrollFortnight.options).some(opt => opt.value === currentValue)) {
                    payrollFortnight.value = currentValue;
                }
            }
        }

        // Show manage fortnights modal
        function showManageFortnightsModal() {
            const tbody = document.getElementById('fortnightsList');
            tbody.innerHTML = '';

            appData.fortnights
                .sort((a, b) => new Date(b.startDate) - new Date(a.startDate))
                .forEach(fortnight => {
                    const site = appData.sites.find(s => s.id === fortnight.siteId);
                    if (!site) return;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${site.name}</td>
                        <td>${formatDate(fortnight.startDate)}</td>
                        <td>${formatDate(fortnight.endDate)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteFortnight('${fortnight.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

            showModal('manageFortnightsModal');
        }

        // Delete fortnight
        function deleteFortnight(fortnightId) {
            if (!confirm('Delete this fortnight? All attendance data for this period will be lost.')) return;

            appData.fortnights = appData.fortnights.filter(f => f.id !== fortnightId);
            // Note: We're NOT deleting attendance data as requested - attendance should persist

            saveData();
            updateFortnightSelectors();

            // Update modal
            showManageFortnightsModal();
            showNotification('Fortnight deleted', 'success');
        }

        // ======================
        // PAYROLL
        // ======================

        // Load payroll
        function loadPayroll() {
            // Just clear the table
            document.getElementById('payrollTableBody').innerHTML = `
                <tr>
                    <td colspan="10" style="text-align: center; padding: 20px;">
                        Select site and fortnight, then click Calculate
                    </td>
                </tr>
            `;

            updatePayrollTotals(0, 0, 0, 0);
        }

        // Calculate payroll
        function calculatePayroll() {
            const siteId = document.getElementById('payrollSite').value;
            const fortnightId = document.getElementById('payrollFortnight').value;

            if (!siteId || !fortnightId) {
                showNotification('Please select site and fortnight', 'error');
                return;
            }

            const site = appData.sites.find(s => s.id === siteId);
            const fortnight = appData.fortnights.find(f => f.id === fortnightId);

            if (!site || !fortnight) {
                showNotification('Invalid site or fortnight', 'error');
                return;
            }

            // Get assigned workers
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            const assignedWorkers = appData.workers
                .filter(w => assignedWorkerIds.includes(w.id) && w.active)
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    return a.surname.localeCompare(b.surname);
                });

            // Generate dates
            const dates = [];
            const currentDate = new Date(fortnight.startDate);
            for (let i = 0; i < 14; i++) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Calculate payroll
            const payrollData = [];
            let totalGross = 0, totalLoans = 0, totalCredit = 0, totalNet = 0;

            assignedWorkers.forEach(worker => {
                // Count present days
                let presentDays = 0;
                dates.forEach(date => {
                    const attendance = appData.attendance.find(a =>
                        a.workerId === worker.id &&
                        a.siteId === siteId &&
                        a.date === date
                    );
                    if (attendance && attendance.status === 'P') presentDays++;
                });

                const grossPay = presentDays * worker.dailyRate;

                // Get loans (they owe us)
                const workerLoans = appData.loans.filter(l =>
                    l.workerId === worker.id &&
                    l.type === 'loan' &&
                    l.status === 'pending' &&
                    l.deduct
                );
                const totalLoansAmount = workerLoans.reduce((sum, loan) => sum + loan.amount, 0);

                // Get credit (we owe them)
                const workerCredit = appData.loans.filter(l =>
                    l.workerId === worker.id &&
                    l.type === 'credit' &&
                    l.status === 'pending'
                );
                const totalCreditAmount = workerCredit.reduce((sum, credit) => sum + credit.amount, 0);

                const netPay = grossPay - totalLoansAmount + totalCreditAmount;

                totalGross += grossPay;
                totalLoans += totalLoansAmount;
                totalCredit += totalCreditAmount;
                totalNet += netPay;

                payrollData.push({
                    worker,
                    presentDays,
                    grossPay,
                    loans: totalLoansAmount,
                    credit: totalCreditAmount,
                    netPay
                });
            });

            // Render payroll table
            renderPayrollTable(payrollData);
            updatePayrollTotals(totalGross, totalLoans, totalCredit, totalNet);
        }

        // Render payroll table
        function renderPayrollTable(payrollData) {
            const tbody = document.getElementById('payrollTableBody');
            tbody.innerHTML = '';

            if (payrollData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 20px;">
                            No workers assigned
                        </td>
                    </tr>
                `;
                return;
            }

            payrollData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.worker.name} ${data.worker.surname}</td>
                    <td>${data.worker.role}</td>
                    <td>${data.presentDays}</td>
                    <td>R${data.worker.dailyRate.toLocaleString()}</td>
                    <td>R${data.grossPay.toLocaleString()}</td>
                    <td>R${data.loans.toLocaleString()}</td>
                    <td>R${data.credit.toLocaleString()}</td>
                    <td style="font-weight: bold;">R${data.netPay.toLocaleString()}</td>
                    <td>${data.worker.bank}</td>
                    <td>${data.worker.account}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update payroll totals
        function updatePayrollTotals(gross, loans, credit, net) {
            document.getElementById('totalGross').textContent = 'R' + gross.toLocaleString();
            document.getElementById('totalLoans').textContent = 'R' + loans.toLocaleString();
            document.getElementById('totalCredit').textContent = 'R' + credit.toLocaleString();
            document.getElementById('totalNet').textContent = 'R' + net.toLocaleString();
        }

        // Save payroll
        function savePayroll() {
            const siteId = document.getElementById('payrollSite').value;
            const fortnightId = document.getElementById('payrollFortnight').value;

            if (!siteId || !fortnightId) {
                showNotification('Please calculate payroll first', 'error');
                return;
            }

            // Get payroll data from table
            const rows = document.querySelectorAll('#payrollTableBody tr');
            const payrollItems = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 10) {
                    const name = cells[0].textContent;
                    const worker = appData.workers.find(w =>
                        `${w.name} ${w.surname}` === name
                    );

                    if (worker) {
                        payrollItems.push({
                            workerId: worker.id,
                            presentDays: parseInt(cells[2].textContent),
                            grossPay: parseFloat(cells[4].textContent.replace('R', '').replace(/,/g, '')),
                            loans: parseFloat(cells[5].textContent.replace('R', '').replace(/,/g, '')),
                            credit: parseFloat(cells[6].textContent.replace('R', '').replace(/,/g, '')),
                            netPay: parseFloat(cells[7].textContent.replace('R', '').replace(/,/g, ''))
                        });
                    }
                }
            });

            if (payrollItems.length === 0) return;

            const payroll = {
                id: generateId(),
                siteId,
                fortnightId,
                items: payrollItems,
                totalGross: parseFloat(document.getElementById('totalGross').textContent.replace('R', '').replace(/,/g, '')),
                totalLoans: parseFloat(document.getElementById('totalLoans').textContent.replace('R', '').replace(/,/g, '')),
                totalCredit: parseFloat(document.getElementById('totalCredit').textContent.replace('R', '').replace(/,/g, '')),
                totalNet: parseFloat(document.getElementById('totalNet').textContent.replace('R', '').replace(/,/g, '')),
                createdAt: new Date().toISOString()
            };

            appData.payrolls.push(payroll);

            // Mark loans as deducted
            payrollItems.forEach(item => {
                if (item.loans > 0) {
                    appData.loans.forEach(loan => {
                        if (loan.workerId === item.workerId && loan.type === 'loan' && loan.status === 'pending') {
                            loan.status = 'deducted';
                            loan.payrollId = payroll.id;
                        }
                    });
                }

                if (item.credit > 0) {
                    appData.loans.forEach(credit => {
                        if (credit.workerId === item.workerId && credit.type === 'credit' && credit.status === 'pending') {
                            credit.status = 'paid';
                            credit.payrollId = payroll.id;
                        }
                    });
                }
            });

            saveData();
            showNotification('Payroll saved successfully', 'success');
        }

        // Render payroll history
        function renderPayrollHistory() {
            const tbody = document.getElementById('payrollHistoryBody');
            tbody.innerHTML = '';

            appData.payrolls
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .forEach(payroll => {
                    const site = appData.sites.find(s => s.id === payroll.siteId);
                    const fortnight = appData.fortnights.find(f => f.id === payroll.fortnightId);

                    if (site && fortnight) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDate(payroll.createdAt)}</td>
                            <td>${site.name}</td>
                            <td>${formatDate(fortnight.startDate)} - ${formatDate(fortnight.endDate)}</td>
                            <td>${payroll.items.length}</td>
                            <td>R${payroll.totalNet.toLocaleString()}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewPayroll('${payroll.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                });
        }

        // View payroll
        function viewPayroll(payrollId) {
            const payroll = appData.payrolls.find(p => p.id === payrollId);
            if (!payroll) return;

            // Switch to payroll tab and populate
            switchTab('payroll');
            switchSubTab('payroll', 'calculate');

            document.getElementById('payrollSite').value = payroll.siteId;
            document.getElementById('payrollFortnight').value = payroll.fortnightId;

            // Calculate to show data
            setTimeout(() => calculatePayroll(), 100);
        }

        // Export payroll PDF
        function exportPayrollPDF() {
            const siteId = document.getElementById('payrollSite').value;
            const fortnightId = document.getElementById('payrollFortnight').value;

            if (!siteId || !fortnightId) {
                showNotification('Please calculate payroll first', 'error');
                return;
            }

            const site = appData.sites.find(s => s.id === siteId);
            const fortnight = appData.fortnights.find(f => f.id === fortnightId);

            if (!site || !fortnight) return;

            // Get data from table
            const rows = document.querySelectorAll('#payrollTableBody tr');
            const items = [];

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 10) {
                    items.push({
                        name: cells[0].textContent,
                        role: cells[1].textContent,
                        days: cells[2].textContent,
                        rate: cells[3].textContent,
                        gross: cells[4].textContent,
                        loans: cells[5].textContent,
                        credit: cells[6].textContent,
                        net: cells[7].textContent,
                        bank: cells[8].textContent,
                        account: cells[9].textContent
                    });
                }
            });

            if (items.length === 0) return;

            // Create PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            // Header
            doc.setFontSize(16);
            doc.text('TONNILAYS CONSTRUCTION - PAYROLL', 14, 20);

            doc.setFontSize(12);
            doc.text(`Site: ${site.name}`, 14, 30);
            doc.text(`Period: ${formatDate(fortnight.startDate)} - ${formatDate(fortnight.endDate)}`, 14, 37);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 44);

            // Table
            const tableData = [['Name', 'Role', 'Days', 'Rate', 'Gross', 'Loans', 'Credit', 'Net', 'Bank', 'Account']];

            items.forEach(item => {
                tableData.push([
                    item.name,
                    item.role,
                    item.days,
                    item.rate,
                    item.gross,
                    item.loans,
                    item.credit,
                    item.net,
                    item.bank,
                    item.account
                ]);
            });

            // Totals
            const totals = [
                'TOTAL',
                '',
                '',
                '',
                document.getElementById('totalGross').textContent,
                document.getElementById('totalLoans').textContent,
                document.getElementById('totalCredit').textContent,
                document.getElementById('totalNet').textContent,
                '',
                ''
            ];

            tableData.push(totals);

            doc.autoTable({
                startY: 50,
                head: [tableData[0]],
                body: tableData.slice(1, -1),
                foot: [tableData[tableData.length - 1]],
                theme: 'grid',
                styles: { fontSize: 7, cellPadding: 2 },
                headStyles: { fillColor: [44, 62, 80] },
                footStyles: { fillColor: [52, 152, 219], textColor: [255, 255, 255], fontStyle: 'bold' }
            });

            // Save
            doc.save(`Payroll_${site.name}_${fortnight.startDate}.pdf`);
            showNotification('Payroll exported to PDF', 'success');
        }

        // ======================
        // LOANS & CREDIT
        // ======================

        // Show add loan modal
        function showAddLoanModal() {
            // Populate worker dropdown sorted by role then surname
            const select = document.getElementById('loanWorker');
            select.innerHTML = '<option value="">Select Worker</option>';

            appData.workers
                .filter(w => w.active)
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    if (a.surname !== b.surname) return a.surname.localeCompare(b.surname);
                    return a.name.localeCompare(b.name);
                })
                .forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.id;
                    option.textContent = `${worker.name} ${worker.surname} (${worker.role})`;
                    select.appendChild(option);
                });

            // Reset form
            document.getElementById('loanType').value = 'loan';
            document.getElementById('loanAmount').value = '';
            document.getElementById('loanDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('loanDescription').value = '';
            document.getElementById('loanStatus').value = 'pending';
            document.getElementById('loanDeduct').checked = true;
            document.getElementById('loanEditId').value = '';

            showModal('addLoanModal');
        }

        // Show edit loan modal
        function showEditLoanModal(loanId) {
            const loan = appData.loans.find(l => l.id === loanId);
            if (!loan) return;

            currentState.editLoanId = loanId;

            // Populate worker dropdown
            const select = document.getElementById('loanWorker');
            select.innerHTML = '<option value="">Select Worker</option>';

            appData.workers
                .filter(w => w.active)
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    if (a.surname !== b.surname) return a.surname.localeCompare(b.surname);
                    return a.name.localeCompare(b.name);
                })
                .forEach(worker => {
                    const option = document.createElement('option');
                    option.value = worker.id;
                    option.textContent = `${worker.name} ${worker.surname} (${worker.role})`;
                    if (worker.id === loan.workerId) option.selected = true;
                    select.appendChild(option);
                });

            // Populate form
            document.getElementById('loanType').value = loan.type;
            document.getElementById('loanAmount').value = loan.amount;
            document.getElementById('loanDate').value = loan.date;
            document.getElementById('loanDescription').value = loan.description || '';
            document.getElementById('loanStatus').value = loan.status;
            document.getElementById('loanDeduct').checked = loan.deduct || false;
            document.getElementById('loanEditId').value = loan.id;

            showModal('addLoanModal');
        }

        // Save loan
        function saveLoan() {
            const type = document.getElementById('loanType').value;
            const workerId = document.getElementById('loanWorker').value;
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const date = document.getElementById('loanDate').value;
            const description = document.getElementById('loanDescription').value.trim();
            const status = document.getElementById('loanStatus').value;
            const deduct = document.getElementById('loanDeduct').checked;
            const loanId = document.getElementById('loanEditId').value;

            if (!type || !workerId || !amount || !date || !description || !status) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (amount <= 0) {
                showNotification('Amount must be higher than 0', 'error');
                return;
            }

            const loan = {
                id: loanId || generateId(),
                type,
                workerId,
                amount,
                date,
                description,
                status,
                deduct: type === 'loan' ? deduct : false,
                createdAt: new Date().toISOString()
            };

            if (loanId) {
                // Update existing loan
                const index = appData.loans.findIndex(l => l.id === loanId);
                if (index !== -1) {
                    appData.loans[index] = loan;
                }
            } else {
                // Add new loan
                appData.loans.push(loan);
            }

            saveData();
            renderLoans();
            hideModal('addLoanModal');
            
            // If loan is marked as paid and type is loan, add as income
            if (type === 'loan' && status === 'paid') {
                addLoanAsIncome(loan);
            }

            showNotification(`Loan/Credit ${loanId ? 'updated' : 'added'} successfully`, 'success');
            currentState.editLoanId = null;
        }

        // Add loan payment as income
        function addLoanAsIncome(loan) {
            const worker = appData.workers.find(w => w.id === loan.workerId);
            if (!worker) return;

            const income = {
                id: generateId(),
                type: 'income',
                siteId: null,
                amount: loan.amount,
                date: new Date().toISOString().split('T')[0],
                category: 'loan',
                description: `Loan repayment from ${worker.name} ${worker.surname}`,
                status: 'received',
                createdAt: new Date().toISOString()
            };

            appData.expenses.push(income);
            saveData();
            loadTransactions();
        }

        // Render loans
        function renderLoans() {
            renderLoansTable('loans', 'loan');
            renderLoansTable('credit', 'credit');
            renderAllLoansTable();
        }

        // Render loans table
        function renderLoansTable(tabId, type) {
            const tbody = document.getElementById(`${tabId}TableBody`);
            tbody.innerHTML = '';

            const loans = appData.loans
                .filter(l => l.type === type)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (loans.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${type === 'loan' ? 7 : 6}" style="text-align: center; padding: 20px;">No ${type}s found</td></tr>`;
                return;
            }

            loans.forEach(loan => {
                const worker = appData.workers.find(w => w.id === loan.workerId);
                if (!worker) return;

                const row = document.createElement('tr');

                if (type === 'loan') {
                    row.innerHTML = `
                        <td>${formatDate(loan.date)}</td>
                        <td>${worker.name} ${worker.surname}</td>
                        <td>R${loan.amount.toLocaleString()}</td>
                        <td>${loan.description || '-'}</td>
                        <td><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                        <td>${loan.deduct ? 'Yes' : 'No'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="showEditLoanModal('${loan.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteLoan('${loan.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${formatDate(loan.date)}</td>
                        <td>${worker.name} ${worker.surname}</td>
                        <td>R${loan.amount.toLocaleString()}</td>
                        <td>${loan.description || '-'}</td>
                        <td><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="showEditLoanModal('${loan.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteLoan('${loan.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                }

                tbody.appendChild(row);
            });
        }

        // Render all loans table
        function renderAllLoansTable() {
            const tbody = document.getElementById('allLoansTableBody');
            tbody.innerHTML = '';

            const allLoans = [...appData.loans]
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (allLoans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px;">No transactions found</td></tr>';
                return;
            }

            allLoans.forEach(loan => {
                const worker = appData.workers.find(w => w.id === loan.workerId);
                if (!worker) return;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(loan.date)}</td>
                    <td>${worker.name} ${worker.surname}</td>
                    <td>${loan.type === 'loan' ? 'Loan (They Owe)' : 'Credit (We Owe)'}</td>
                    <td>R${loan.amount.toLocaleString()}</td>
                    <td>${loan.description || '-'}</td>
                    <td><span class="status-badge status-${loan.status}">${loan.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="showEditLoanModal('${loan.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteLoan('${loan.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;

                tbody.appendChild(row);
            });
        }

        // Delete loan
        function deleteLoan(loanId) {
            if (!confirm('Delete this transaction?')) return;

            appData.loans = appData.loans.filter(l => l.id !== loanId);
            saveData();
            renderLoans();
            showNotification('Transaction deleted', 'success');
        }

        // ======================
        // EXPENSES & INCOME
        // ======================

        // Save expense
        function saveExpense() {
            const siteId = document.getElementById('expenseSite').value || null;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value.trim();

            if (!amount || !date || !category || !description) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            if (amount <= 0) {
                showNotification('Amount must be higher than 0', 'error');
                return;
            }

            const expense = {
                id: generateId(),
                type: 'expense',
                siteId,
                amount,
                date,
                category,
                description,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            appData.expenses.push(expense);
            saveData();
            loadTransactions();
            hideModal('expenseModal');
            showNotification('Expense added', 'success');
        }

        // Save income
        function saveIncome() {
            const siteId = document.getElementById('incomeSite').value || null;
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            const date = document.getElementById('incomeDate').value;
            const category = document.getElementById('incomeCategory').value;
            const description = document.getElementById('incomeDescription').value.trim();

            if (!amount || !date || !category || !description) {
                showNotification('Please fill all required fields', 'error');
                return;
            }

            if (amount <= 0) {
                showNotification('Amount must be greater than 0', 'error');
                return;
            }

            const income = {
                id: generateId(),
                type: 'income',
                siteId,
                amount,
                date,
                category,
                description,
                status: 'received',
                createdAt: new Date().toISOString()
            };

            appData.expenses.push(income);
            saveData();
            loadTransactions();
            hideModal('incomeModal');
            showNotification('Income added', 'success');
        }

        // Export transactions to Excel
        function exportTransactionsExcel() {
            const data = appData.expenses.map(trans => [
                trans.type === 'income' ? 'Income' : 'Expense',
                formatDate(trans.date),
                trans.siteId ? (appData.sites.find(s => s.id === trans.siteId)?.name || 'Unknown') : 'General',
                trans.category,
                trans.description,
                trans.amount,
                trans.status
            ]);

            const ws = XLSX.utils.aoa_to_sheet([
                ['Type', 'Date', 'Site', 'Category', 'Description', 'Amount', 'Status'],
                ...data
            ]);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
            XLSX.writeFile(wb, `Tonnylays_Transactions_${new Date().toISOString().split('T')[0]}.xlsx`);

            showNotification('Transactions exported successfully', 'success');
        }

        // Load transactions
        function loadTransactions() {
            const typeFilter = document.getElementById('expenseTypeFilter').value;
            const periodFilter = document.getElementById('expensePeriodFilter').value;
            const siteFilter = document.getElementById('expenseSiteFilter').value;

            // Filter transactions
            let filtered = appData.expenses;

            if (typeFilter !== 'all') {
                filtered = filtered.filter(t => t.type === typeFilter);
            }

            if (periodFilter !== 'all') {
                const now = new Date();
                const startDate = new Date();

                switch (periodFilter) {
                    case 'today':
                        startDate.setHours(0, 0, 0, 0);
                        break;
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'fortnight':
                        startDate.setDate(now.getDate() - 14);
                        break;
                    case 'month':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                    case 'year':
                        startDate.setFullYear(now.getFullYear() - 1);
                        break;
                }

                filtered = filtered.filter(t => new Date(t.date) >= startDate);
            }

            if (siteFilter !== 'all') {
                filtered = filtered.filter(t => t.siteId === siteFilter);
            }

            // Sort by date
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Render transactions
            renderTransactionsList(filtered);

            // Update summary
            updateTransactionsSummary();
        }

        // Render transactions list
        function renderTransactionsList(transactions) {
            const container = document.getElementById('transactionsList');

            if (transactions.length === 0) {
                container.innerHTML = '<p>No transactions found</p>';
                return;
            }

            let html = '';
            transactions.slice(0, 15).forEach(transaction => {
                const siteName = transaction.siteId ?
                    appData.sites.find(s => s.id === transaction.siteId)?.name || 'Unknown' :
                    'General';

                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border);">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: var(--dark);">${transaction.description}</div>
                            <div style="font-size: 0.85rem; color: var(--dark); margin-top: 4px;">
                                ${formatDate(transaction.date)}  ${transaction.category}  ${siteName}
                            </div>
                        </div>
                        <div style="font-weight: bold; color: ${transaction.type === 'income' ? 'var(--success)' : 'var(--danger)'};">
                            ${transaction.type === 'income' ? '+' : '-'}R${transaction.amount.toLocaleString()}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update transactions summary
        function updateTransactionsSummary() {
            let totalIncome = 0;
            let totalExpenses = 0;

            appData.expenses.forEach(t => {
                if (t.type === 'income') totalIncome += t.amount;
                else totalExpenses += t.amount;
            });

            const net = totalIncome - totalExpenses;

            document.getElementById('totalIncome').textContent = 'R' + totalIncome.toLocaleString();
            document.getElementById('totalExpenses').textContent = 'R' + totalExpenses.toLocaleString();
            document.getElementById('netBalance').textContent = 'R' + net.toLocaleString();
            document.getElementById('netBalance').style.color = net >= 0 ? 'var(--success)' : 'var(--danger)';
        }

        // ======================
        // INVOICES
        // ======================

        // Start new invoice
        function startNewInvoice() {
            // Clear form
            document.getElementById('invoiceTo').value = '';
            document.getElementById('invoiceAddress').value = '';
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];

            // Clear items
            currentState.invoiceItems = [];
            renderInvoiceItems();

            // Update invoice number
            updateInvoiceNumber();

            showNotification('New invoice started', 'success');
        }

        // Add invoice item
        function addInvoiceItem() {
            const description = document.getElementById('itemDesc').value.trim();
            const quantity = parseFloat(document.getElementById('itemQty').value);
            const rate = parseFloat(document.getElementById('itemRate').value);

            if (!description || !quantity || !rate) {
                showNotification('Please fill all item fields', 'error');
                return;
            }

            if (quantity <= 0 || rate <= 0) {
                showNotification('Quantity and rate must be higher than 0', 'error');
                return;
            }

            const item = {
                id: generateId(),
                description,
                quantity,
                rate,
                amount: quantity * rate
            };

            currentState.invoiceItems.push(item);
            renderInvoiceItems();

            // Clear form
            document.getElementById('itemDesc').value = '';
            document.getElementById('itemQty').value = '1';
            document.getElementById('itemRate').value = '';
        }

        // Remove invoice item
        function removeInvoiceItem(itemId) {
            currentState.invoiceItems = currentState.invoiceItems.filter(item => item.id !== itemId);
            renderInvoiceItems();
        }

        // Render invoice items
        function renderInvoiceItems() {
            const tbody = document.getElementById('invoiceItemsTableBody');
            tbody.innerHTML = '';

            currentState.invoiceItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.description}</td>
                    <td>${item.quantity}</td>
                    <td>R${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    <td>R${item.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeInvoiceItem('${item.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Show invoice preview
        function showInvoicePreview() {
            const to = document.getElementById('invoiceTo').value.trim();
            const address = document.getElementById('invoiceAddress').value.trim();
            const date = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('invoiceDueDate').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();

            if (!to || !address || currentState.invoiceItems.length === 0) {
                showNotification('Please fill client details and add items', 'error');
                return;
            }

            // Calculate totals
            let subtotal = 0;
            currentState.invoiceItems.forEach(item => {
                subtotal += item.amount;
            });

            const vat = subtotal * 0.15; // 15% VAT
            const total = subtotal + vat;

            // Build preview
            const preview = document.getElementById('invoicePreviewContent');
            preview.innerHTML = `
                <div style="background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 25px; border-radius: 12px; text-align: center; color: white; margin-bottom: 25px;">
                    <h2 style="margin: 0 0 10px 0; font-size: 2rem;"><i class="fas fa-hard-hat"></i> INVOICE</h2>
                    <div style="font-size: 1.3rem; font-weight: bold;">${invoiceNumber}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px;">
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--border); padding-bottom: 8px;">From:</h4>
                        <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;">Tonny Lays Pty Ltd</div>
                        <div style="color: var(--dark); margin-bottom: 3px;"><i class="fas fa-envelope"></i> itonmuleya@yahoo.com</div>
                        <div style="color: var(--dark);"><i class="fas fa-phone"></i> 073 062 6432</div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--border); padding-bottom: 8px;">To:</h4>
                        <div style="font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;">${to}</div>
                        <div style="color: var(--dark); margin-bottom: 10px; white-space: pre-line;">${address}</div>
                        <div style="display: flex; justify-content: space-between; border-top: 1px solid var(--border); padding-top: 10px;">
                            <div><strong>Date:</strong> ${formatDate(date)}</div>
                            <div><strong>Due:</strong> ${formatDate(dueDate)}</div>
                        </div>
                    </div>
                </div>
                
                <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 25px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(to right, var(--primary), var(--secondary)); color: white;">
                                <th style="padding: 15px; text-align: left; font-weight: 600;">Description</th>
                                <th style="padding: 15px; text-align: center; font-weight: 600;">Qty</th>
                                <th style="padding: 15px; text-align: right; font-weight: 600;">Rate</th>
                                <th style="padding: 15px; text-align: right; font-weight: 600;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentState.invoiceItems.map(item => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 12px 15px;">${item.description}</td>
                                    <td style="padding: 12px 15px; text-align: center;">${item.quantity}</td>
                                    <td style="padding: 12px 15px; text-align: right;">R${item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                                    <td style="padding: 12px 15px; text-align: right;">R${item.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="max-width: 300px; margin-left: auto;">
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span>Subtotal:</span>
                            <span>R${subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span>VAT (15%):</span>
                            <span>R${vat.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 12px 0; font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                            <span>Total:</span>
                            <span>R${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #feebc8, #fbd38d); border-radius: 10px; text-align: center; border-left: 4px solid var(--accent);">
                    <p style="margin: 0 0 10px 0; font-weight: bold; color: #744210;"><i class="fas fa-hard-hat"></i> Quality Construction Services</p>
                    <p style="margin: 0; color: #744210;">Thank you for your business! Please make payment within 30 days</p>
                </div>
            `;

            showModal('invoicePreviewModal');
        }

        // Generate invoice PDF
        function generateInvoicePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const to = document.getElementById('invoiceTo').value.trim();
            const address = document.getElementById('invoiceAddress').value.trim();
            const date = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('invoiceDueDate').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();

            // Calculate totals
            let subtotal = 0;
            currentState.invoiceItems.forEach(item => {
                subtotal += item.amount;
            });

            const vat = subtotal * 0.15; // 15% VAT
            const total = subtotal + vat;

            // Header with construction theme
            doc.setFillColor(26, 54, 93); // Primary color
            doc.rect(0, 0, 210, 40, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('TONNY LAYS CONSTRUCTION', 105, 18, { align: 'center' });

            doc.setFontSize(18);
            doc.text('INVOICE', 105, 28, { align: 'center' });

            doc.setFontSize(14);
            doc.text(`Invoice #: ${invoiceNumber}`, 105, 38, { align: 'center' });

            // From/To details
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            
            // From section
            doc.text('From:', 14, 55);
            doc.setFont(undefined, 'bold');
            doc.text('Tonny Lays Pty Ltd', 14, 62);
            doc.setFont(undefined, 'normal');
            doc.text('Email: itonmuleya@yahoo.com', 14, 69);
            doc.text('Phone: 073 062 6432', 14, 76);

            // To section
            doc.text('To:', 110, 55);
            doc.setFont(undefined, 'bold');
            
            // Break address into lines
            const addressLines = doc.splitTextToSize(to, 80);
            let yPos = 62;
            addressLines.forEach(line => {
                doc.text(line, 110, yPos);
                yPos += 7;
            });

            doc.setFont(undefined, 'normal');
            const addrLines = doc.splitTextToSize(address, 80);
            addrLines.forEach(line => {
                doc.text(line, 110, yPos);
                yPos += 7;
            });

            // Dates
            doc.text(`Date: ${formatDate(date)}`, 110, yPos + 5);
            doc.text(`Due: ${formatDate(dueDate)}`, 110, yPos + 12);

            // Items table
            const tableData = [['Description', 'Quantity', 'Rate', 'Amount']];

            currentState.invoiceItems.forEach(item => {
                tableData.push([
                    item.description,
                    item.quantity.toString(),
                    'R' + item.rate.toLocaleString(undefined, { minimumFractionDigits: 2 }),
                    'R' + item.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })
                ]);
            });

            doc.autoTable({
                startY: 90,
                head: [tableData[0]],
                body: tableData.slice(1),
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 5 },
                headStyles: { fillColor: [26, 54, 93], textColor: [255, 255, 255] },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 30 },
                    2: { cellWidth: 35 },
                    3: { cellWidth: 35 }
                },
                didDrawPage: function (data) {
                    // Totals
                    const finalY = data.cursor.y + 10;

                    doc.setFontSize(12);
                    doc.text(`Subtotal: R${subtotal.toLocaleString(undefined, { minimumFractionDigits: 2 })}`, 140, finalY);
                    doc.text(`VAT (15%): R${vat.toLocaleString(undefined, { minimumFractionDigits: 2 })}`, 140, finalY + 7);

                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Total: R${total.toLocaleString(undefined, { minimumFractionDigits: 2 })}`, 140, finalY + 17);

                    // Footer
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text('Thank you for your business!', 105, doc.internal.pageSize.height - 20, { align: 'center' });
                    doc.text('Quality Construction Services - 073 062 6432', 105, doc.internal.pageSize.height - 15, { align: 'center' });
                }
            });

            // Save
            doc.save(`Invoice_${invoiceNumber}.pdf`);
            showNotification('Invoice PDF downloaded', 'success');

            // Close preview
            hideModal('invoicePreviewModal');
        }

        // Save invoice
        function saveInvoice() {
            const to = document.getElementById('invoiceTo').value.trim();
            const address = document.getElementById('invoiceAddress').value.trim();
            const date = document.getElementById('invoiceDate').value;
            const dueDate = document.getElementById('invoiceDueDate').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value.trim();

            if (!to || !address || !invoiceNumber || currentState.invoiceItems.length === 0) {
                showNotification('Please complete all fields and add items', 'error');
                return;
            }

            // Calculate totals
            let subtotal = 0;
            currentState.invoiceItems.forEach(item => {
                subtotal += item.amount;
            });

            const vat = subtotal * 0.15; // 15% VAT
            const total = subtotal + vat;

            // Check for duplicate invoice number
            const duplicate = appData.invoices.find(i => i.invoiceNumber === invoiceNumber);
            if (duplicate) {
                if (!confirm('Invoice number exists. Overwrite?')) return;
                appData.invoices = appData.invoices.filter(i => i.id !== duplicate.id);
            }

            const invoice = {
                id: generateId(),
                to,
                address,
                date,
                dueDate,
                invoiceNumber,
                items: currentState.invoiceItems,
                subtotal,
                vat,
                total,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            appData.invoices.push(invoice);
            saveData();

            // Clear form
            startNewInvoice();

            // Update invoices list
            renderInvoices();

            showNotification('Invoice saved successfully', 'success');

            // Close preview
            hideModal('invoicePreviewModal');
        }

        // Render invoices
        function renderInvoices() {
            const tbody = document.getElementById('invoicesTableBody');
            tbody.innerHTML = '';

            appData.invoices
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(invoice => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${invoice.invoiceNumber}</td>
                        <td>${formatDate(invoice.date)}</td>
                        <td>${invoice.to}</td>
                        <td>R${invoice.total.toLocaleString(undefined, { minimumFractionDigits: 2 })}</td>
                        <td><span class="status-badge status-${invoice.status}">${invoice.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="viewSavedInvoice('${invoice.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="downloadInvoice('${invoice.id}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteInvoice('${invoice.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
        }

        // View saved invoice
        function viewSavedInvoice(invoiceId) {
            const invoice = appData.invoices.find(i => i.id === invoiceId);
            if (!invoice) return;

            // Populate form
            document.getElementById('invoiceTo').value = invoice.to;
            document.getElementById('invoiceAddress').value = invoice.address;
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('invoiceDueDate').value = invoice.dueDate;
            document.getElementById('invoiceNumber').value = invoice.invoiceNumber;

            // Set items
            currentState.invoiceItems = [...invoice.items];
            renderInvoiceItems();

            showNotification('Invoice loaded', 'success');
            switchTab('invoices');
        }

        // Download invoice
        function downloadInvoice(invoiceId) {
            const invoice = appData.invoices.find(i => i.id === invoiceId);
            if (!invoice) return;

            // Set current invoice
            document.getElementById('invoiceTo').value = invoice.to;
            document.getElementById('invoiceAddress').value = invoice.address;
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('invoiceDueDate').value = invoice.dueDate;
            document.getElementById('invoiceNumber').value = invoice.invoiceNumber;
            currentState.invoiceItems = [...invoice.items];

            // Generate PDF
            generateInvoicePDF();
        }

        // Delete invoice
        function deleteInvoice(invoiceId) {
            if (!confirm('Delete this invoice?')) return;

            appData.invoices = appData.invoices.filter(i => i.id !== invoiceId);
            saveData();
            renderInvoices();
            showNotification('Invoice deleted', 'success');
        }

        // ======================
        // BACKUP & RESTORE
        // ======================

        // Backup data
        function backupData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', `tonnylays_backup_${new Date().toISOString().split('T')[0]}.json`);
            link.click();

            showNotification('Backup downloaded', 'success');
        }

        // Restore backup
        function restoreBackup() {
            const fileInput = document.getElementById('backupFile');
            const file = fileInput.files[0];

            if (!file) {
                showNotification('Please select a backup file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const backupData = JSON.parse(e.target.result);

                    if (!confirm('This will replace all current data. Continue?')) return;

                    appData = backupData;
                    saveData();
                    renderAll();

                    hideModal('restoreModal');
                    showNotification('Data restored successfully', 'success');

                    // Clear file input
                    fileInput.value = '';

                } catch (error) {
                    showNotification('Error reading backup file', 'error');
                }
            };

            reader.readAsText(file);
        }

        // ======================
        // UTILITY FUNCTIONS
        // ======================

        // Generate ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-ZA', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Format date short
        function formatDateShort(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-ZA', {
                month: 'short',
                day: 'numeric'
            });
        }

        // Export attendance PDF
        function exportAttendancePDF() {
            const siteId = document.getElementById('attendanceSite').value;
            const fortnightId = document.getElementById('fortnightSelect').value;

            if (!siteId || !fortnightId) {
                showNotification('Please select site and fortnight', 'error');
                return;
            }

            const site = appData.sites.find(s => s.id === siteId);
            const fortnight = appData.fortnights.find(f => f.id === fortnightId);

            if (!site || !fortnight) return;

            // Get workers and dates
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            const workers = appData.workers
                .filter(w => assignedWorkerIds.includes(w.id) && w.active)
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    return a.surname.localeCompare(b.surname);
                });

            const dates = [];
            const currentDate = new Date(fortnight.startDate);
            for (let i = 0; i < 14; i++) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Create PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            // Header
            doc.setFontSize(16);
            doc.text('TONNILAYS - ATTENDANCE REGISTER', 14, 20);

            doc.setFontSize(12);
            doc.text(`Site: ${site.name}`, 14, 30);
            doc.text(`Period: ${formatDate(fortnight.startDate)} - ${formatDate(fortnight.endDate)}`, 14, 37);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 44);

            // Table data
            const tableData = [['Worker', ...dates.map(d => formatDateShort(d))]];

            workers.forEach(worker => {
                const row = [`${worker.name} ${worker.surname}`];

                dates.forEach(date => {
                    const attendance = appData.attendance.find(a =>
                        a.workerId === worker.id &&
                        a.siteId === siteId &&
                        a.date === date
                    );
                    row.push(attendance ? attendance.status : '');
                });

                tableData.push(row);
            });

            doc.autoTable({
                startY: 50,
                head: [tableData[0]],
                body: tableData.slice(1),
                theme: 'grid',
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [44, 62, 80] }
            });

            doc.save(`Attendance_${site.name}_${fortnight.startDate}.pdf`);
            showNotification('Attendance saved as PDF', 'success');
        }

        // Export attendance Excel
        function exportAttendanceExcel() {
            const siteId = document.getElementById('attendanceSite').value;
            const fortnightId = document.getElementById('fortnightSelect').value;

            if (!siteId || !fortnightId) {
                showNotification('Please select site and fortnight', 'error');
                return;
            }

            const site = appData.sites.find(s => s.id === siteId);
            const fortnight = appData.fortnights.find(f => f.id === fortnightId);

            if (!site || !fortnight) return;

            // Get data
            const assignedWorkerIds = appData.siteAssignments
                .filter(a => a.siteId === siteId && !a.endDate)
                .map(a => a.workerId);

            const workers = appData.workers
                .filter(w => assignedWorkerIds.includes(w.id) && w.active)
                .sort((a, b) => {
                    if (a.role !== b.role) return a.role.localeCompare(b.role);
                    return a.surname.localeCompare(b.surname);
                });

            const dates = [];
            const currentDate = new Date(fortnight.startDate);
            for (let i = 0; i < 14; i++) {
                dates.push(currentDate.toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Create worksheet
            const wsData = [
                ['TONNILAYS - ATTENDANCE REGISTER'],
                [`Site: ${site.name}`],
                [`Period: ${formatDate(fortnight.startDate)} - ${formatDate(fortnight.endDate)}`],
                [`Date: ${new Date().toLocaleDateString()}`],
                [],
                ['Worker', ...dates.map(d => formatDateShort(d))]
            ];

            workers.forEach(worker => {
                const row = [`${worker.name} ${worker.surname}`];

                dates.forEach(date => {
                    const attendance = appData.attendance.find(a =>
                        a.workerId === worker.id &&
                        a.siteId === siteId &&
                        a.date === date
                    );
                    row.push(attendance ? attendance.status : '');
                });

                wsData.push(row);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Attendance');

            XLSX.writeFile(wb, `Attendance_${site.name}_${fortnight.startDate}.xlsx`);
            showNotification('Attendance exported to Excel', 'success');
        }

        // Initialize the app
        window.onload = initApp;
    </script>
</body>
</html>